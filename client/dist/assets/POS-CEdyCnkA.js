import{r as i,j as e,Z as zt,$ as Dt,az as It,a0 as Et,a1 as Ft,I as At,A as yt,s as Fe,m as Rt,n as Ct,u as Ot,R as vt,aA as Mt,aB as St,aC as Nt,aD as Pt,K as st,x as Ze,aE as $t,aF as Bt,af as et,aG as _t,a3 as Wt,aH as lt,aI as Lt,aJ as Vt,a8 as qt,aK as Ht,C as Qe,q as Gt,aL as Jt,aM as Qt,aN as Ut,i as Ke,aO as Yt,V as Kt,aa as Xt,X as Zt,aP as eo,aQ as to,H as oo,W as dt,aR as ct,aS as Je,aT as pt,ac as ao,ah as no,a4 as ro}from"./vendor-BJZlzDLx.js";import{M as wt,S as ee,P as io,a as so,b as lo,c as Ee,d as Be,B as k,T as ie,I as mt,e as xt,H as co,f as po,g as mo,C as xo,h as fo,i as uo,R as Le,Q as go,j as ft}from"./POS.styles-CuhWBpp8.js";import{u as tt,a as ho,m as bo,p as jo,q as ut,r as gt,t as yo,v as Co,n as vo,w as Xe,x as So}from"./index-eefq-jxX.js";import{S as No,T as wo}from"./SalesHistoryModal-CqrNoPe0.js";import"./AlertModal-4fpfKD_M.js";import{C as ko}from"./ConfirmationModal-TCJfVCIE.js";import"./scanner-vendor-DfxRpMWJ.js";import"./pdf-vendor-BoQlG7Vl.js";const ht=n=>Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),bt=Fe.button`
  display: flex; align-items: center; justify-content: center;
  width: 42px; height: 42px;
  border: 1px solid ${n=>n.$active?"#3b82f6":"#cbd5e1"};
  background-color: ${n=>n.$active?"#eff6ff":"#fff"};
  color: ${n=>n.$active?"#3b82f6":"#64748b"};
  border-radius: 8px; cursor: pointer; transition: all 0.2s;

  &:hover { border-color: #3b82f6; color: #3b82f6; }
`,To=({isOpen:n,imageSrc:z,onClose:r})=>!n||!z?null:e.jsx(Ee,{onClick:r,children:e.jsxs(Rt.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:L=>L.stopPropagation(),style:{position:"relative",maxWidth:"95%",maxHeight:"90vh"},children:[e.jsx("button",{onClick:r,style:{position:"absolute",top:-15,right:-15,background:"white",width:32,height:32,borderRadius:"50%",border:"none",cursor:"pointer",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10,color:"#ef4444"},children:e.jsx(Ct,{})}),e.jsx("img",{src:z,alt:"Vista Ampliada",style:{maxWidth:"100%",maxHeight:"85vh",borderRadius:"12px",boxShadow:"0 20px 25px rgba(0,0,0,0.2)",background:"white",objectFit:"contain"}})]})});function zo({products:n=[],searchTerm:z,setSearchTerm:r,onProductClick:L,cartItems:B=[],reservedStock:Q,inputRef:p,searchType:U="description",setSearchType:w=()=>{}}){const[b,_]=i.useState({isOpen:!1,imageUrl:null}),K=i.useMemo(()=>{const l=new Map;for(const m of B){const y=m.id_producto||m.id;l.set(y,(l.get(y)||0)+Number(m.quantity||0))}return l},[B]),ae=i.useMemo(()=>{const l=(z||"").toLowerCase().trim();return n.filter(y=>{const x=W=>W?String(W).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():"",V=x(l);if(!V)return!0;if(U==="code"){const W=x(y.codigo),u=x(y.codigo_barras);return W.startsWith(V)||u.startsWith(V)}else{const W=x(y.nombre),u=x(y.descripcion),q=x(y.codigo);return W.includes(V)||u.includes(V)||q.includes(V)}}).slice(0,100)},[n,z,U]),j=i.useMemo(()=>{const l=(z||"").toLowerCase().trim();return l?n.filter(m=>{const y=(m.nombre||"").toLowerCase(),x=String(m.codigo||"").toLowerCase();return y.includes(l)||x.includes(l)}).length:n.length},[n,z]);return e.jsxs(wt,{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"1rem",alignItems:"center"},children:[e.jsx(ee,{ref:p,placeholder:U==="code"?"Escribe código...":"Buscar producto...",value:z,onChange:l=>r(l.target.value)}),e.jsx(bt,{$active:U==="description",onClick:()=>{var l;w("description"),(l=p.current)==null||l.focus()},title:"Buscar por Nombre",children:e.jsx(zt,{size:16})}),e.jsx(bt,{$active:U==="code",onClick:()=>{var l;w("code"),(l=p.current)==null||l.focus()},title:"Buscar por Código",children:e.jsx(Dt,{size:18})})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",padding:"0 4px",fontSize:"0.85rem",color:"#64748b"},children:[e.jsxs("span",{children:[e.jsx(It,{color:"#3b82f6"})," ",ae.length," mostrados"]}),e.jsxs("span",{children:["Total: ",j]})]}),e.jsx(io,{children:ae.map(l=>{const m=l.id_producto||l.id,y=K.get(m)||0,x=(Q==null?void 0:Q.get(m))||0,V=Math.max(0,Number(l.existencia||0)-y-x),W=V<=0;return e.jsxs(so,{onClick:()=>!W&&L(l),outOfStock:W,title:l.nombre,children:[e.jsx(lo,{lowstock:V<5&&!W,outOfStock:W,children:W?"Agotado":`Stock: ${V}`}),e.jsxs("div",{className:"image-placeholder",style:{position:"relative",height:160,background:"#f8fafc",display:"flex",alignItems:"center",justifyContent:"center",borderBottom:"1px solid #f1f5f9",overflow:"hidden"},children:[l.imagen&&e.jsx("div",{className:"eye-icon",onClick:u=>{u.stopPropagation(),_({isOpen:!0,imageUrl:l.imagen})},style:{position:"absolute",top:10,left:10,zIndex:20,background:"white",borderRadius:"50%",width:32,height:32,display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",cursor:"pointer",transition:"transform 0.2s"},title:"Ver imagen",children:e.jsx(Et,{size:14,color:"#64748b"})}),l.imagen?e.jsx("img",{src:l.imagen,alt:l.nombre,loading:"lazy",style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}):e.jsx(Ft,{className:"no-image-icon",size:40,color:"#e2e8f0"})]}),e.jsxs("div",{className:"info",style:{padding:"12px",flex:1,display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx("div",{className:"product-name",style:{fontWeight:600,fontSize:"0.88rem",color:"#1e293b",lineHeight:"1.25",height:"3.8rem",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical"},children:l.nombre}),e.jsx("div",{style:{fontSize:"0.85rem",fontWeight:"bold",color:"#334155",marginBottom:"4px"},children:l.codigo||"S/C"}),(Number(l.mayorista)>0||Number(l.mayoreo)>0)&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",display:"flex",alignItems:"center",gap:"4px",marginTop:"auto",marginBottom:"1px"},children:[e.jsx(At,{size:10})," May: C$ ",ht(l.mayorista||l.mayoreo)]}),e.jsxs("div",{className:"price",style:{fontWeight:800,color:"#2563eb",fontSize:"1.05rem",marginTop:Number(l.mayorista)>0||Number(l.mayoreo)>0?0:"auto"},children:["C$ ",ht(l.precio_venta||l.precio)]})]})]},m)})}),e.jsx(yt,{children:b.isOpen&&e.jsx(To,{isOpen:!0,imageSrc:b.imageUrl,onClose:()=>_({isOpen:!1,imageUrl:null})})})]})}const Do=vt.memo(()=>e.jsx("style",{children:`
  /* Importar League Spartan */
  @import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600;800;900&display=swap');

  @media print {
    body { visibility: hidden; margin: 0; padding: 0; }
    .print-area, .print-area * { visibility: visible !important; }
    .print-area {
      position: absolute !important; left: 0 !important; top: 0 !important;
      z-index: 999999 !important; margin: 0 !important; padding: 0 !important;
    }
    .no-print { display: none !important; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; box-shadow: none !important; text-shadow: none !important; }
  }
  `})),Io=Fe.div`
  font-family: 'League Spartan', 'Consolas', sans-serif; color: #000; background: #fff;
  width: 310px; margin: 0 auto; padding: 12px 6px;
  box-shadow: 0 0 10px rgba(0,0,0,.08); border: 1px solid #eee; border-radius: 8px;

  /* Encabezado */
  .brand { text-align: center; border-bottom: 3px solid #000; padding-bottom: 12px; margin-bottom: 15px; }
  .brand img { max-width: 120px; display: block; margin: 0 auto 10px; }
  .brand h2 { margin: 0 0 6px; font-size: 1.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
  .brand p { margin: 3px 0; font-size: 1rem; font-weight: 700; }

  /* Secciones y Filas */
  .section { margin-bottom: 18px; border-bottom: 1px dashed #000; padding-bottom: 12px; }
  .section:last-child { border-bottom: none; }
  .section-title { font-weight: 900; text-align: center; text-transform: uppercase; font-size: 1.2rem; margin-bottom: 10px; text-decoration: underline; letter-spacing: 0.5px; }
  
  .row { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 6px; align-items: baseline; font-weight: 600; }
  .row.big { font-size: 1.5rem; font-weight: 900; margin-top: 12px; border-top: 3px solid #000; padding-top: 8px; }
  .row.sub { font-size: 0.9rem; color: #333; font-style: italic; padding-left: 10px; margin-bottom: 4px; font-weight: 400; }
  .row.alert { background: #eee; padding: 8px; font-weight: 900; text-align: center; justify-content: center; gap: 10px; border: 2px solid #000; margin-top: 12px; font-size: 1.4rem; }

  /* Tablas simples */
  table { width: 100%; border-collapse: collapse; font-size: 1rem; margin-top: 8px; }
  th { border-bottom: 2px solid #000; text-align: left; font-weight: 900; padding: 4px 2px; }
  td { border-bottom: 1px dashed #ccc; padding: 4px 2px; }
  .text-right { text-align: right; }

  /* Firma */
  .signature { margin-top: 60px; text-align: center; page-break-inside: avoid; }
  .signature-line { border-top: 2px solid #000; width: 80%; margin: 0 auto 8px; }
  .signature p { font-size: 1.1rem; font-weight: 700; }

  @media print {
    &.print-80 {
      width: 80mm !important; 
      font-family: 'League Spartan', sans-serif !important; 
      padding: 0px !important; border: none !important; box-shadow: none !important;
    }
  }
`,Eo=(n,z)=>{var L,B;if(!n)return"N/A";if((L=n.pagoDetalles)!=null&&L.clienteNombre)return n.pagoDetalles.clienteNombre;const r=((B=n.pagoDetalles)==null?void 0:B.clienteId)||n.clientId;if(r&&(z==null?void 0:z.length)>0){const Q=z.find(p=>String(p.id_cliente)===String(r));if(Q)return Q.nombre}return null},jt=({currentUser:n,isCajaOpen:z,session:r,onOpenCaja:L,onCloseCaja:B,onClose:Q,isAdmin:p,showConfirmation:U,showAlert:w,initialTasaDolar:b,clients:_=[]})=>{var T,Re;const[K,ae]=i.useState(""),[j,l]=i.useState(b||36.6),[m,y]=i.useState(""),[x,V]=i.useState(!1),W=Ot(),u=(n==null?void 0:n.id_usuario)||(n==null?void 0:n.id);let q=(T=r==null?void 0:r.openedBy)==null?void 0:T.name;!q&&(r!=null&&r.openedBy)&&typeof r.openedBy=="string"&&(q=r.openedBy),q||(q=(r==null?void 0:r.userId)===u?(n==null?void 0:n.nombre_usuario)||(n==null?void 0:n.username):"Usuario"),q||(q="Caja General");const te=p||(r==null?void 0:r.userId)===u||((Re=r==null?void 0:r.openedBy)==null?void 0:Re.id)===u,D=i.useMemo(()=>Array.isArray(r==null?void 0:r.transactions)?r.transactions:[],[r]),{cajaInicial:c,netCordobas:Ne,netDolares:je,efectivoEsperado:ye,efectivoEsperadoCordobas:ke,efectivoEsperadoDolares:Ae,ventasContado:Ue,devoluciones:Te,cancelaciones:fe,entradas:I,salidas:E,abonos:X,totalTarjeta:we,totalTransferencia:oe,totalCredito:de,totalNoEfectivo:Z,sumDevolucionesCancelaciones:H,totalVentasDia:re,tasaRef:ze,totalHidden:ce}=i.useMemo(()=>{const s=Number((r==null?void 0:r.initialAmount)||0),F=Number((r==null?void 0:r.tasaDolar)||b||36.6),$={ventasContado:[],devoluciones:[],cancelaciones:[],entradas:[],salidas:[],abonos:[]};let g=0,me=0,ne=0,f=0,Y=0,ge=0,J=0,Oe=0;for(const le of D){const A=((le==null?void 0:le.type)||"").toLowerCase();let M=(le==null?void 0:le.pagoDetalles)||{};if(typeof M=="string")try{M=JSON.parse(M)}catch{M={}}(!M||typeof M!="object")&&(M={});let Ve=Number(M.ingresoCaja!==void 0?M.ingresoCaja:le.amount||0),Ce=Number(M.totalVenta!==void 0?M.totalVenta:le.amount||0);(A==="salida"||A.includes("devolucion")||A.includes("cancelacion"))&&(Ve=-Math.abs(Ve),Ce=-Math.abs(Ce));const he=Ve,ve={...le,pagoDetalles:M,displayAmount:Ce};if(A.includes("abono")){const qe=Eo(ve,_);qe&&(ve.resolvedClientName=qe)}const Pe=Number(M.tarjeta||0),$e=Number(M.transferencia||0),We=Number(M.credito||0);A.startsWith("venta")||A.includes("abono")||A.includes("pedido")?(ne+=Pe,f+=$e,Y+=We):A.includes("devolucion")||A.includes("cancelacion")?(ne-=Pe,f-=$e,Y-=We):A==="ajuste"&&(M.target==="tarjeta"&&(ne+=Number(le.amount||0)),M.target==="credito"&&(Y+=Number(le.amount||0)),M.target==="transferencia"&&(f+=Number(le.amount||0))),A.startsWith("venta")||A==="venta_contado"||A==="venta_mixta"||A==="venta_credito"?M.efectivo!==void 0||M.dolares!==void 0?(g+=Number(M.efectivo||0)-Number(M.cambio||0),me+=Number(M.dolares||0)):g+=he-Pe-$e-We:A.includes("abono")?M.dolares!==void 0?(me+=Number(M.dolares||0),g+=Number(M.efectivo||0)):g+=he:A==="entrada"?g+=Math.abs(he):A==="salida"?g-=Math.abs(he):A.includes("devolucion")||A.includes("cancelacion")?g+=he:A==="ajuste"?(M.target==="efectivo"&&(g+=he,M.hidden&&(Oe+=he)),M.target==="dolares"&&(me+=he)):g+=he-Pe-$e,A.startsWith("venta")||A.includes("abono")||A==="entrada"?ge+=Math.abs(Ce):A.includes("devolucion")||A.includes("cancelacion")?ge-=Math.abs(Ce):A==="ajuste"&&(ge+=Ce),A.startsWith("venta")?$.ventasContado.push(ve):A.includes("devolucion")?($.devoluciones.push(ve),J+=Math.abs(Ce)):A.includes("cancelacion")?($.cancelaciones.push(ve),J+=Math.abs(Ce)):A==="entrada"?$.entradas.push(ve):A==="salida"?$.salidas.push(ve):A.includes("abono")&&$.abonos.push(ve)}const Me=s+g+me*F;return{cajaInicial:s,netCordobas:g,netDolares:me,efectivoEsperado:Me,efectivoEsperadoCordobas:s+g,efectivoEsperadoDolares:me,ventasContado:$.ventasContado,devoluciones:$.devoluciones,cancelaciones:$.cancelaciones,entradas:$.entradas,salidas:$.salidas,abonos:$.abonos,totalTarjeta:ne,totalTransferencia:f,totalCredito:Y,totalNoEfectivo:ne+f+Y,sumDevolucionesCancelaciones:J,totalVentasDia:ge,tasaRef:F,totalHidden:Oe}},[D,r,b,_]),G=Number(m||0)-ye;r!=null&&r.openedAt&&new Date(r.openedAt);const pe=()=>{const s=parseFloat(K||0);if(isNaN(s)||s<0)return w({title:"Inválido",message:"Monto inicial >= 0"});L(s,Number(j||36.6))},_e=()=>{if(isNaN(parseFloat(m)))return w({title:"Requerido",message:"Ingrese el monto contado físico."});V(!0)},O=vt.useCallback(()=>{const s=document.getElementById("print-wrapper-caja");if(!s)return;const F=s.outerHTML,$=`
        @charset "UTF-8";
        @import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600;800;900&display=swap');
        @page { size: 80mm auto; margin: 0; }
        html, body {
          background: #fff; margin: 0 !important; padding: 0 !important;
          -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
          color: #000 !important; font-family: 'League Spartan', sans-serif !important;
        }
        #print-wrapper-caja, #print-wrapper-caja * {
          color: #000 !important; font-weight: 700 !important;
          text-shadow: none !important; box-shadow: none !important;
          visibility: visible !important;
        }
        #print-wrapper-caja {
          width: 80mm !important; padding: 0 !important; border: none !important;
        }
        .brand h2 { font-size: 20pt !important; letter-spacing: 2px !important; margin-bottom: 5px !important; }
        .section-title { font-size: 14pt !important; margin-bottom: 12px !important; border-bottom: 2px solid #000 !important; }
        .row { font-size: 12pt !important; margin-bottom: 6px !important; font-weight: 900 !important; }
        .row.big { font-size: 16pt !important; margin-top: 15px !important; border-top: 4px solid #000 !important; }
        .row.alert { font-size: 18pt !important; padding: 10px !important; border: 4px solid #000 !important; }
        .text-right { text-align: right !important; }
        
        @media print {
          * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
      `,g=window.open("","_blank","width=500,height=600");g&&(g.document.write(`<html><head><title>Cierre Caja</title><style>${$}</style></head><body>${F}</body></html>`),g.document.close(),g.focus(),g.onload=function(){setTimeout(()=>{g.print()},300)},g.onafterprint=()=>{try{g.close()}catch{}})},[]),se=()=>{O(),setTimeout(()=>{B(Number(m))},800)},S=s=>`C$${Number(s||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,ue=s=>`$${Number(s||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return e.jsxs(Ee,{className:"no-print",children:[e.jsx(Do,{}),e.jsxs(Be,{style:{maxWidth:x?450:760,padding:x?0:"1.5rem",background:"#f8f9fa"},children:[!x&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[e.jsx("h2",{style:{margin:0},children:"Gestión de Caja"}),e.jsx(k,{$cancel:!0,onClick:Q,style:{borderRadius:"50%",width:32,height:32,padding:0},children:"✕"})]}),z?x?e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",maxHeight:"90vh"},children:[e.jsxs("div",{style:{padding:"15px 20px",background:"#343a40",color:"#fff",display:"flex",justifyContent:"space-between",alignItems:"center",borderRadius:"8px 8px 0 0"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:"1.2rem",fontWeight:"800",letterSpacing:"0.5px"},children:"REPORTAR CIERRE DE CAJA"}),e.jsx("p",{style:{margin:0,fontSize:"0.9rem",opacity:.8},children:new Date().toLocaleString("es-NI")})]}),e.jsxs(k,{$cancel:!0,onClick:()=>V(!1),style:{padding:"8px 15px",fontSize:"0.9rem",background:"rgba(255,255,255,0.2)",border:"none"},children:[e.jsx(St,{})," Volver / Editar"]})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto",background:"#f8f9fa",padding:"20px"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:15,marginBottom:20},children:[e.jsxs("div",{style:{background:"#fff",padding:15,borderRadius:8,boxShadow:"0 2px 5px rgba(0,0,0,0.05)",borderLeft:"4px solid #007bff"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#666",textTransform:"uppercase"},children:"Ventas Netas"}),e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"800",color:"#333"},children:S(re)}),H>0&&e.jsxs("div",{style:{fontSize:"0.7rem",color:"#dc3545"},children:["(-",S(H)," devol/cancel)"]})]}),e.jsxs("div",{style:{background:"#fff",padding:15,borderRadius:8,boxShadow:"0 2px 5px rgba(0,0,0,0.05)",borderLeft:"4px solid #28a745"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#666",textTransform:"uppercase"},children:"Efectivo Real"}),e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"800",color:"#28a745"},children:S(m)})]}),e.jsxs("div",{style:{background:"#fff",padding:15,borderRadius:8,boxShadow:"0 2px 5px rgba(0,0,0,0.05)",borderLeft:`4px solid ${G<0?"#dc3545":"#ffc107"}`},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#666",textTransform:"uppercase"},children:"Diferencia"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"800",color:G!==0?G<0?"#dc3545":"#e0a800":"#28a745"},children:[G>0?"+":"",S(G)]})]})]}),e.jsxs("div",{style:{background:"#fff",padding:20,borderRadius:8,boxShadow:"0 2px 10px rgba(0,0,0,0.05)",marginBottom:20},children:[e.jsx("h4",{style:{margin:"0 0 15px",borderBottom:"1px solid #eee",paddingBottom:10},children:"Arqueo Detallado"}),e.jsx("table",{style:{width:"100%",borderCollapse:"collapse"},children:e.jsxs("tbody",{children:[e.jsxs("tr",{style:{borderBottom:"1px solid #f1f1f1"},children:[e.jsx("td",{style:{padding:10},children:"Fondo Inicial"}),e.jsx("td",{className:"text-right",style:{padding:10,fontWeight:"bold"},children:S(c)})]}),e.jsx("tr",{style:{background:"#f8f9fa"},children:e.jsx("td",{colSpan:"2",style:{padding:"8px 10px",fontSize:"0.85rem",fontWeight:"bold",color:"#007bff"},children:"RESUMEN DE INGRESOS"})}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"4px 10px 4px 20px",fontSize:"0.9rem"},children:"(+) Ingresos Netos (Ventas + Abonos - Devoluciones)"}),e.jsx("td",{className:"text-right",style:{padding:"4px 10px",fontSize:"0.9rem"},children:S(re)})]}),H>0&&e.jsxs("tr",{children:[e.jsxs("td",{style:{padding:"4px 10px 4px 30px",fontSize:"0.85rem",color:"#dc3545",fontStyle:"italic"},children:["↳ Incluye: -",S(H)," en devoluciones/cancelaciones"]}),e.jsx("td",{})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"4px 10px 4px 20px",fontSize:"0.9rem",color:"#dc3545"},children:"(-) Tarjetas / Transf / Crédito"}),e.jsxs("td",{className:"text-right",style:{padding:"4px 10px",fontSize:"0.9rem",color:"#dc3545"},children:["- ",S(Z)]})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"4px 10px 4px 20px",fontSize:"0.9rem",color:"#dc3545"},children:"(-) Salidas de Efectivo"}),e.jsxs("td",{className:"text-right",style:{padding:"4px 10px",fontSize:"0.9rem",color:"#dc3545"},children:["- ",S(E.reduce((s,F)=>s+Math.abs(F.displayAmount||0),0))]})]}),e.jsxs("tr",{style:{borderBottom:"1px solid #f1f1f1",background:"#e8f5e9"},children:[e.jsx("td",{style:{padding:10,fontWeight:"bold",fontSize:"1.1rem"},children:"Esperado en Caja"}),e.jsx("td",{className:"text-right",style:{padding:10,fontWeight:"bold",fontSize:"1.1rem",color:"#146c43"},children:S(ye)})]})]})})]}),(X.length>0||Te.length>0||fe.length>0||E.length>0)&&e.jsxs("div",{style:{background:"#fff",padding:20,borderRadius:8,boxShadow:"0 2px 10px rgba(0,0,0,0.05)"},children:[e.jsx("h4",{style:{margin:"0 0 15px",borderBottom:"1px solid #eee",paddingBottom:10},children:"Detalle de Movimientos"}),X.length>0&&e.jsxs("div",{style:{marginBottom:15},children:[e.jsx("h5",{style:{color:"#007bff",margin:"0 0 5px"},children:"Abonos Recibidos"}),X.map((s,F)=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px dashed #eee"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.resolvedClientName||"Cliente General"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#666"},children:s.note||"Abono de cuenta"})]}),e.jsxs("div",{style:{fontWeight:"bold",color:"#28a745"},children:["+ ",S(s.amount)]})]},F))]}),Te.length>0&&e.jsxs("div",{style:{marginBottom:15},children:[e.jsx("h5",{style:{color:"#e67e22",margin:"0 0 5px"},children:"Devoluciones"}),Te.map((s,F)=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px dashed #eee"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.note||"Devolución"}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#666"},children:["#",s.id]})]}),e.jsxs("div",{style:{fontWeight:"bold",color:"#dc3545"},children:["- ",S(Math.abs(s.amount))]})]},F))]}),fe.length>0&&e.jsxs("div",{style:{marginBottom:15},children:[e.jsx("h5",{style:{color:"#dc3545",margin:"0 0 5px"},children:"Cancelaciones"}),fe.map((s,F)=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px dashed #eee"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.note||"Cancelación"}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#666"},children:["#",s.id]})]}),e.jsxs("div",{style:{fontWeight:"bold",color:"#dc3545"},children:["- ",S(Math.abs(s.amount))]})]},F))]}),E.length>0&&e.jsxs("div",{children:[e.jsx("h5",{style:{color:"#dc3545",margin:"0 0 5px"},children:"Salidas de Caja"}),E.map((s,F)=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px dashed #eee"},children:[e.jsx("div",{children:s.note||"Salida Varia"}),e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545"},children:S(Math.abs(s.amount))})]},F))]})]})]}),e.jsx("div",{style:{display:"none"},children:e.jsxs(Io,{id:"print-wrapper-caja",className:"print-80",children:[e.jsxs("div",{className:"brand",children:[e.jsx("img",{src:"/icons/logo.png",alt:"Logo",style:{filter:"grayscale(100%) contrast(150%)"}}),e.jsx("h2",{children:"CIERRE DE CAJA"}),e.jsx("p",{children:"Multirepuestos RG"}),e.jsx("p",{children:new Date().toLocaleString("es-NI")}),e.jsxs("p",{children:["Cajero: ",q]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"1. INGRESOS NETOS DEL DÍA"}),e.jsxs("div",{className:"row big",children:[e.jsx("span",{children:"TOTAL NETO:"}),e.jsx("span",{children:S(re)})]}),e.jsx("div",{className:"row sub",children:"(Ventas + Abonos - Devoluciones - Cancelaciones)"}),H>0&&e.jsxs("div",{className:"row",style:{color:"#dc3545"},children:[e.jsx("span",{children:"(-) Devol/Cancel:"}),e.jsxs("span",{children:["-",S(H)]})]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"2. DESGLOSE NO EFECTIVO"}),we>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Tarjetas:"}),e.jsx("span",{children:S(we)})]}),oe>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Transf.:"}),e.jsx("span",{children:S(oe)})]}),de>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Créditos:"}),e.jsx("span",{children:S(de)})]}),e.jsxs("div",{className:"row",style:{borderTop:"1px dashed #000"},children:[e.jsx("span",{children:"TOTAL NO EFECTIVO:"}),e.jsx("span",{children:S(Z)})]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"3. FLUJO EFECTIVO (RESUMEN)"}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Fondo Inicial:"}),e.jsx("span",{children:S(c)})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(+) Ingresos Netos:"}),e.jsx("span",{children:S(re)})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) No Efectivo:"}),e.jsxs("span",{children:["-",S(Z)]})]}),Math.abs(E.reduce((s,F)=>s+Math.abs(F.displayAmount||0),0))>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Salidas:"}),e.jsxs("span",{children:["-",S(E.reduce((s,F)=>s+Math.abs(F.displayAmount||0),0))]})]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"4. ARQUEO FINAL"}),e.jsxs("div",{className:"row big",children:[e.jsx("span",{children:"EFECTIVO ESPERADO:"}),e.jsx("span",{children:S(ye)})]}),e.jsxs("div",{className:"row sub",children:["(",S(ke)," + ",ue(Ae),")"]}),e.jsxs("div",{className:"row",style:{marginTop:8,paddingTop:4,borderTop:"1px dashed #ccc"},children:[e.jsx("span",{children:"EFECTIVO REAL:"}),e.jsx("span",{children:S(m)})]}),e.jsxs("div",{className:"row alert",style:{color:"#000",borderColor:"#000"},children:[e.jsx("span",{children:"DIFERENCIA:"}),e.jsxs("span",{children:[G>0?"+":"",S(G)]})]}),e.jsx("div",{style:{textAlign:"center",fontSize:"0.75rem",fontWeight:"bold",marginTop:2},children:Math.abs(G)<.5?"(CAJA CUADRADA)":G>0?"(SOBRANTE)":"(FALTANTE)"})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"5. DETALLE DE MOVIMIENTOS"}),e.jsx("table",{style:{marginTop:0},children:e.jsxs("tbody",{children:[X.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#f8f9fa",fontSize:"0.9rem"},children:"--- ABONOS Y CRÉDITOS ---"})}),X.map((s,F)=>e.jsxs("tr",{children:[e.jsxs("td",{style:{fontSize:"0.9rem"},children:[s.resolvedClientName||s.note||"Abono"," ",e.jsx("br",{}),e.jsxs("span",{style:{fontSize:"0.75rem",color:"#555"},children:["#",s.id]})]}),e.jsx("td",{className:"text-right",style:{fontSize:"0.9rem"},children:S(s.amount)})]},"a"+F))]}),Te.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#fff3cd",fontSize:"0.9rem",paddingTop:8},children:"--- DEVOLUCIONES ---"})}),Te.map((s,F)=>e.jsxs("tr",{children:[e.jsxs("td",{style:{fontSize:"0.9rem",color:"#dc3545"},children:[s.note||"Devolución"," ",e.jsx("br",{}),e.jsxs("span",{style:{fontSize:"0.75rem",color:"#555"},children:["#",s.id]})]}),e.jsxs("td",{className:"text-right",style:{fontSize:"0.9rem",color:"#dc3545"},children:["-",S(Math.abs(s.amount))]})]},"d"+F))]}),fe.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#fee2e2",fontSize:"0.9rem",paddingTop:8},children:"--- CANCELACIONES ---"})}),fe.map((s,F)=>e.jsxs("tr",{children:[e.jsxs("td",{style:{fontSize:"0.9rem",color:"#dc3545"},children:[s.note||"Cancelación"," ",e.jsx("br",{}),e.jsxs("span",{style:{fontSize:"0.75rem",color:"#555"},children:["#",s.id]})]}),e.jsxs("td",{className:"text-right",style:{fontSize:"0.9rem",color:"#dc3545"},children:["-",S(Math.abs(s.amount))]})]},"c"+F))]}),E.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#f8f9fa",fontSize:"0.9rem",paddingTop:8},children:"--- SALIDAS DE EFECTIVO ---"})}),E.map((s,F)=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.9rem"},children:s.note||"Salida Varia"}),e.jsx("td",{className:"text-right",style:{fontSize:"0.9rem"},children:S(Math.abs(s.amount))})]},"s"+F))]}),I.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#f8f9fa",fontSize:"0.9rem",paddingTop:8},children:"--- ENTRADAS DE EFECTIVO ---"})}),I.map((s,F)=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.9rem"},children:s.note||"Entrada Varia"}),e.jsx("td",{className:"text-right",style:{fontSize:"0.9rem"},children:S(s.amount)})]},"e"+F))]})]})}),X.length===0&&E.length===0&&I.length===0&&e.jsx("div",{style:{textAlign:"center",fontStyle:"italic",fontSize:"0.8rem",padding:5},children:"Sin movimientos extra"})]}),e.jsxs("div",{className:"signature",children:[e.jsx("div",{className:"signature-line"}),e.jsx("p",{children:"Firma Responsable"})]})]})}),e.jsxs("div",{style:{padding:"20px",background:"#fff",borderTop:"1px solid #ccc",display:"flex",gap:10,justifyContent:"flex-end"},children:[e.jsx(k,{$cancel:!0,onClick:()=>V(!1),children:"Seguir Editando"}),e.jsxs(k,{primary:!0,style:{padding:"12px 24px",fontSize:"1rem",display:"flex",alignItems:"center",gap:8},onClick:se,disabled:!te,children:[e.jsx(Nt,{})," IMPRIMIR Y CERRAR CAJA"]})]}),!te&&e.jsx("div",{style:{padding:5,textAlign:"center",color:"red",fontSize:"0.8rem"},children:"Solo el Admin o quien abrió puede cerrar."})]}):e.jsxs("div",{children:[e.jsx("h3",{style:{color:"#dc3545",borderBottom:"2px solid #dc3545",paddingBottom:10},children:"Arqueo y Cierre"}),e.jsx("div",{style:{background:"#e9ecef",padding:10,borderRadius:6,marginBottom:15},children:e.jsxs(ie,{style:{fontSize:"1.1rem"},children:[e.jsxs("span",{children:[e.jsx(Pt,{})," Abrió:"]}),e.jsx("strong",{children:q})]})}),e.jsxs("div",{style:{marginTop:8,padding:"15px",backgroundColor:"#f8f9fa",borderRadius:6,border:"1px dashed #ced4da"},children:[e.jsx("div",{style:{fontWeight:"800",marginBottom:10,fontSize:"1.2rem",color:"#495057"},children:"Efectivo a Tener:"}),e.jsxs(ie,{style:{fontSize:"1.3rem"},children:[e.jsx("span",{children:"Córdobas:"}),e.jsxs("strong",{style:{color:"#198754"},children:["C$ ",Number(ke).toLocaleString()]})]}),e.jsxs(ie,{style:{fontSize:"1.3rem"},children:[e.jsx("span",{children:"Dólares:"}),e.jsxs("strong",{style:{color:"#198754"},children:["$ ",Number(Ae).toLocaleString()]})]}),e.jsxs(ie,{$bold:!0,style:{marginTop:10,borderTop:"2px solid #ccc",paddingTop:10,fontSize:"1.5rem"},children:[e.jsx("span",{children:"TOTAL (C$):"}),e.jsx("span",{children:S(ye)})]})]}),e.jsx("label",{style:{display:"block",marginTop:20,fontWeight:800,fontSize:"1.3rem"},children:"Monto Contado Físico (C$)"}),e.jsx(ee,{type:"number",step:"0.01",value:m,onChange:s=>y(s.target.value),autoFocus:!0,placeholder:"Total Billetes + Monedas",style:{fontSize:"1.5rem",padding:"12px",height:"auto"}}),m&&e.jsxs(ie,{$bold:!0,style:{marginTop:15,color:G!==0?"#dc3545":"#28a745",fontSize:"1.8rem",padding:"10px",background:G!==0?"#fff5f5":"#f0fff4",borderRadius:8,border:`2px solid ${G!==0?"#dc3545":"#28a745"}`},children:[e.jsx("span",{children:"Diferencia:"}),e.jsx("span",{children:S(G)})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginTop:20},children:[e.jsx(k,{primary:!0,style:{flex:1},onClick:_e,disabled:!te||!m,children:"Ver Reporte"}),e.jsx(k,{$cancel:!0,onClick:Q,children:"Cancelar"})]})]}):e.jsxs("div",{style:{padding:x?"1rem":0},children:[e.jsxs("h3",{style:{color:"#28a745",borderBottom:"2px solid #28a745",paddingBottom:10},children:[e.jsx(Mt,{})," Abrir Caja"]}),e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsx("label",{style:{fontWeight:600},children:"Monto Inicial (C$)"}),e.jsx(ee,{type:"number",step:"0.01",value:K,onChange:s=>ae(s.target.value),autoFocus:!0}),e.jsx("label",{style:{fontWeight:600},children:"Tasa del Dólar"}),e.jsx(ee,{type:"number",step:"0.01",value:j,onChange:s=>l(s.target.value)})]}),e.jsxs("div",{style:{marginTop:20,display:"flex",gap:10},children:[e.jsx(k,{primary:!0,style:{flex:1},onClick:pe,children:"Abrir Caja"}),e.jsx(k,{onClick:()=>W("/dashboard"),children:"Ir al Dashboard"})]})]})]})]})},He=n=>{const z=parseFloat(n);return Number.isNaN(z)||Math.abs(z)<.001?0:z},Fo=({total:n=0,tasaDolar:z=1,onClose:r,onFinishSale:L,clientes:B=[],users:Q=[],showAlert:p,initialClientId:U="0",cartSnapshot:w=[],currentUserId:b=void 0,orderSubtotal:_=void 0,orderDiscountAmount:K=void 0})=>{const[ae,j]=i.useState("0.00"),[l,m]=i.useState("0.00"),[y,x]=i.useState("0.00"),[V,W]=i.useState("0.00"),[u,q]=i.useState(""),[te,D]=i.useState(""),[c,Ne]=i.useState("contado"),[je,ye]=i.useState(U??"0"),[ke,Ae]=i.useState(!1),[Ue,Te]=i.useState(!1),fe=i.useMemo(()=>{const f=parseInt(je,10);return Number.isNaN(f)?0:f},[je]),I=fe!==0,E=i.useMemo(()=>He(ae),[ae]),X=i.useMemo(()=>He(l),[l]),we=i.useMemo(()=>He(y),[y]),oe=i.useMemo(()=>He(V),[V]),de=i.useMemo(()=>we*Number(z||1),[we,z]),Z=i.useMemo(()=>E+X+oe+de,[E,X,oe,de]),H=i.useMemo(()=>X>.01,[X]),re=i.useMemo(()=>Number(n)-Z,[n,Z]),ze=i.useMemo(()=>c==="credito"&&I&&re>.01?re:(Z>=Number(n)-1e-4,0),[c,I,re,Z,n]),ce=i.useMemo(()=>{const f=He(re);return f<=.01||c==="credito"&&I?0:f},[re,c,I]),G=i.useMemo(()=>Math.max(0,-re),[re]),pe=i.useMemo(()=>ze>.01?Z>.01?"mixto":"credito_total":"contado",[ze,Z]),_e=i.useMemo(()=>{if(ce>.01)return"PAGO INCOMPLETO";if((pe==="mixto"||pe==="credito_total")&&!I)return"CLIENTE NO SELECCIONADO";switch(pe){case"mixto":return"PAGO MIXTO (Contado + Crédito)";case"credito_total":return"CRÉDITO TOTAL";default:return"CONTADO"}},[pe,ce,I]),O=i.useMemo(()=>c==="credito"&&!I,[c,I]),se=i.useMemo(()=>ke||ce>.01||(pe==="mixto"||pe==="credito_total")&&!I||H&&!u.trim()||oe>.01&&!te.trim(),[ke,ce,pe,I,H,u,oe,te]),S=i.useMemo(()=>Array.isArray(w)?w.map(({raw:f,costo:Y,existencia:ge,...J})=>({id:J.id||J.id_producto,nombre:J.nombre??J.descripcion??J.producto??"",quantity:Number(J.quantity||0),precio:Number(J.precio_venta??J.precio??0)})).filter(f=>f.quantity>0):[],[w]),ue=i.useMemo(()=>typeof _=="number"?Number(_):S.reduce((f,Y)=>f+Number(Y.precio||0)*Number(Y.quantity||0),0),[_,S]);i.useMemo(()=>{if(typeof K=="number")return Number(K);const f=Number(ue)-Number(n);return f>0?f:0},[K,ue,n]),i.useEffect(()=>{c==="contado"&&Z===0&&Number(n)>0&&j(Number(n).toFixed(2)),c==="credito"&&!I&&ye("0")},[c,n]);const T=i.useCallback(f=>{const Y=String(f.target.value);ye(Y),(parseInt(Y,10)||0)!==0&&(Ne("contado"),Z<Number(n)&&Z===0&&j(Number(n).toFixed(2)))},[Z,n]),Re=i.useCallback(()=>{Ne("contado");const f=X+oe+de,Y=Math.max(0,Number(n)-f);j(Number(Y).toFixed(2))},[X,oe,de,n]),s=i.useCallback(()=>{if(!I){p==null||p({title:"Cliente Requerido",message:"Debe seleccionar un cliente para habilitar la opción de Crédito.",type:"error"});return}Ne("credito"),j("0.00"),m("0.00"),x("0.00"),W("0.00"),q(""),D("")},[I,p]),F=i.useCallback(()=>{j(Number(n).toFixed(2)),m("0.00"),x("0.00"),W("0.00"),q(""),D(""),Ne("contado")},[n]),$=({efectivo:f,tarjeta:Y,transferencia:ge,dolaresLocal:J,credito:Oe})=>{const Me=f+Y+ge+J>.01;return Oe&&Me?"mixto":Oe&&!Me?"credito_total":"contado"},g=async f=>{if(!I||fe===0){p==null||p({title:"Cliente Requerido",message:"No puedes vender sin seleccionar un cliente. Por favor selecciona uno.",type:"error"});return}if((pe==="credito_total"||pe==="mixto")&&fe===0){p==null||p({title:"Cliente Requerido",message:"Debe seleccionar un cliente para ventas a crédito o mixtas.",type:"error"});return}if(ce>.01){p==null||p({title:"Pago Incompleto",message:`Faltan C$${ce.toFixed(2)} para completar la venta.`,type:"warning"});return}if(H&&!u.trim()){p==null||p({title:"Dato Requerido",message:"Ingrese el número de referencia para el pago con tarjeta.",type:"warning"});return}if(oe>.01&&!te.trim()){p==null||p({title:"Dato Requerido",message:"Ingrese el número de referencia para la transferencia.",type:"warning"});return}if(ke)return;Ae(!0);const Y=Math.max(0,E+de-G),ge={totalVenta:Number(n),efectivo:E,tarjeta:X,transferencia:oe,dolares:we,tasaDolarAlMomento:Number(z),referenciaTarjeta:u.trim(),referenciaTransferencia:te.trim(),credito:ze,clienteId:fe,tipoVenta:$({efectivo:E,tarjeta:X,transferencia:oe,dolaresLocal:de,credito:c==="credito"}),cambio:Number(G),ingresoCaja:Number(Y),shouldPrintNow:f};try{typeof L=="function"&&await L(ge),r==null||r()}catch(J){p==null||p({title:"Error",message:(J==null?void 0:J.message)||"No se pudo completar la venta.",type:"error"})}finally{Ae(!1)}},me=I?ce>.01?"#dc3545":G>.01?"#28a745":"#17a2b8":"#dc3545",ne=I?ce>.01?`¡FALTA CUBRIR! C$${ce.toFixed(2)}`:G>.01?`CAMBIO A ENTREGAR: C$${G.toFixed(2)}`:"BALANCE PERFECTO":"¡SELECCIONA UN CLIENTE!";return e.jsx(Ee,{children:e.jsxs(Be,{style:{maxWidth:"950px",width:"96%",maxHeight:"90vh",overflow:"hidden",borderRadius:16,backgroundColor:"#f8f9fa",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"2px solid #e9ecef",paddingBottom:15,marginBottom:20},children:[e.jsxs("h2",{style:{margin:0,color:"#1e293b",fontSize:"1.5rem",fontWeight:800},children:[e.jsx(st,{style:{marginRight:"0.5rem",color:"#007bff"}})," PROCESAR PAGO"]}),e.jsx(k,{$cancel:!0,onClick:r,style:{borderRadius:"50%",width:40,height:40,padding:0,fontSize:"1.2rem",backgroundColor:"#fee2e2",color:"#ef4444",borderColor:"transparent"},children:e.jsx(Ze,{})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"5fr 4fr",gap:"2rem",height:"calc(90vh - 140px)"},children:[e.jsxs("div",{style:{paddingRight:10,borderRight:"1px solid #e2e8f0",overflowY:"auto",paddingBottom:10},children:[e.jsxs("div",{style:{padding:20,border:"1px solid #e2e8f0",borderRadius:12,backgroundColor:"#fff",marginBottom:20,boxShadow:"0 1px 3px rgba(0,0,0,0.05)"},children:[e.jsxs("h4",{style:{marginTop:0,color:"#334155",fontSize:"1rem",fontWeight:700,textTransform:"uppercase",marginBottom:15},children:[e.jsx($t,{style:{marginRight:6}})," Tipo de Venta"]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20},children:[e.jsx(k,{onClick:Re,style:{flex:1,padding:"10px 0",backgroundColor:c==="contado"?"#0ea5e9":"#f1f5f9",color:c==="contado"?"#fff":"#475569",border:"none",borderRadius:8,fontWeight:"700",boxShadow:c==="contado"?"0 4px 6px -1px rgba(14, 165, 233, 0.4)":"none"},children:"CONTADO"}),e.jsx(k,{onClick:s,disabled:!I,style:{flex:1,padding:"10px 0",backgroundColor:c==="credito"?"#f59e0b":"#f1f5f9",color:c==="credito"?"#fff":"#475569",border:"none",borderRadius:8,fontWeight:"700",boxShadow:c==="credito"?"0 4px 6px -1px rgba(245, 158, 11, 0.4)":"none",opacity:I?1:.5},children:"CRÉDITO"})]}),e.jsxs("label",{style:{display:"block",fontWeight:"700",marginBottom:8,color:"#475569",fontSize:"0.9rem"},children:[e.jsx(Bt,{})," Seleccionar Cliente ",e.jsx("span",{style:{color:"#ef4444"},children:"* (Obligatorio)"})]}),e.jsxs(ee,{as:"select",value:je,onChange:T,style:{height:42,padding:"0 12px",width:"100%",fontSize:"1rem",border:I?"2px solid #22c55e":"2px solid #ef4444",backgroundColor:I?"#f0fdf4":"#fef2f2",borderRadius:8},children:[e.jsx("option",{value:"0",children:"-- Seleccionar Cliente --"}),(B||[]).map(f=>e.jsxs("option",{value:f.id_cliente??f.id,children:[f.nombre,Number(f.saldo_pendiente||0)>0?` (Deuda: C$${Number(f.saldo_pendiente).toFixed(2)})`:""]},f.id_cliente??f.id))]}),!I&&e.jsxs("p",{style:{color:"#ef4444",margin:"8px 0 0",fontSize:"0.85rem",fontWeight:"600"},children:[e.jsx(Ze,{style:{marginRight:4}})," No puedes vender sin seleccionar un cliente."]})]}),e.jsxs("div",{style:{padding:20,border:"1px solid #e2e8f0",borderRadius:12,backgroundColor:"#fff",boxShadow:"0 1px 3px rgba(0,0,0,0.05)"},children:[e.jsx("h4",{style:{marginTop:0,color:"#334155",fontSize:"1rem",fontWeight:700,textTransform:"uppercase",borderBottom:"1px solid #f1f5f9",paddingBottom:10,marginBottom:15},children:"Desglose de Pago (C$)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"15px"},children:[e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(et,{})," Efectivo"]}),e.jsx(ee,{type:"number",step:"0.01",value:ae,onChange:f=>j(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:O})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(_t,{})," Dólares"]}),e.jsx(ee,{type:"number",step:"0.01",value:y,onChange:f=>x(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:O})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(st,{})," Tarjeta"]}),e.jsx(ee,{type:"number",step:"0.01",value:l,onChange:f=>m(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:O})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(St,{})," Transferencia"]}),e.jsx(ee,{type:"number",step:"0.01",value:V,onChange:f=>W(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:O})]})]}),c==="credito"&&e.jsxs("div",{style:{marginTop:15,padding:12,backgroundColor:"#fff7ed",borderRadius:8,border:"1px dashed #f97316"},children:[e.jsxs("label",{style:{display:"block",fontWeight:"700",fontSize:"0.85rem",marginBottom:4,color:"#c2410c"},children:[e.jsx(Wt,{})," CRÉDITO GENERADO"]}),e.jsxs("div",{style:{fontSize:"1.2rem",color:"#ea580c",fontWeight:800},children:["C$ ",ze.toFixed(2)]})]}),H&&e.jsxs("div",{style:{marginTop:15,padding:12,border:"1px solid #fcd34d",borderRadius:8,backgroundColor:"#fffbeb"},children:[e.jsxs("label",{style:{display:"block",fontWeight:"700",fontSize:"0.85rem",color:"#b45309",marginBottom:6},children:[e.jsx(lt,{})," Nº Referencia Tarjeta ",e.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),e.jsx(ee,{type:"text",placeholder:"Ej: 1234",value:u,onChange:f=>q(f.target.value),style:{width:"100%",height:36,fontSize:"0.95rem"}})]}),oe>.01&&e.jsxs("div",{style:{marginTop:15,padding:12,border:"1px solid #bae6fd",borderRadius:8,backgroundColor:"#f0f9ff"},children:[e.jsxs("label",{style:{display:"block",fontWeight:"700",fontSize:"0.85rem",color:"#0369a1",marginBottom:6},children:[e.jsx(lt,{})," Nº Referencia Transferencia ",e.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),e.jsx(ee,{type:"text",placeholder:"Ej: REF-5678",value:te,onChange:f=>D(f.target.value),style:{width:"100%",height:36,fontSize:"0.95rem"}})]}),c==="contado"&&e.jsxs(k,{info:!0,onClick:F,style:{width:"100%",padding:"12px 0",marginTop:20,backgroundColor:"#e0f2fe",color:"#0284c7",border:"1px dashed #0ea5e9",fontSize:"0.95rem",fontWeight:600},children:[e.jsx(Lt,{})," Rellenar con Efectivo (Total: C$ ",Number(n).toFixed(2),")"]})]})]}),e.jsxs("div",{style:{paddingLeft:10,display:"flex",flexDirection:"column",justifyContent:"space-between",paddingBottom:10},children:[e.jsxs("div",{children:[e.jsxs(mt,{style:{marginBottom:15,padding:20,backgroundColor:"#f0f9ff",border:"none",borderRadius:12,boxShadow:"inset 0 2px 4px rgba(0,0,0,0.05)"},children:[e.jsxs(ie,{$bold:!0,style:{fontSize:"1.8rem",color:"#0f172a",marginBottom:5},children:[e.jsx("span",{style:{fontSize:"1rem",color:"#64748b",fontWeight:600},children:"TOTAL A PAGAR"}),e.jsxs("span",{children:["C$ ",Number(n).toFixed(2)]})]}),e.jsxs(ie,{style:{borderTop:"1px solid #cbd5e0",paddingTop:10,fontSize:"0.9rem",color:"#64748b"},children:[e.jsxs("span",{children:["Tasa USD: C$ ",Number(z).toFixed(2)]}),e.jsxs("span",{style:{color:"#0f172a",fontWeight:700},children:["$",(Number(n)/Number(z||1)).toFixed(2)," USD"]})]})]}),e.jsxs("div",{style:{padding:15,border:"1px solid #e2e8f0",borderRadius:12,marginBottom:15,backgroundColor:"#fff"},children:[e.jsxs(ie,{style:{color:"#64748b",fontSize:"0.95rem",marginBottom:8},children:[e.jsx("span",{children:"Pagado (Contado)"}),e.jsxs("span",{style:{fontWeight:"700",color:"#1e293b"},children:["C$ ",Z.toFixed(2)]})]}),e.jsxs(ie,{style:{fontSize:"0.95rem"},children:[e.jsx("span",{children:"Estado"}),e.jsx("span",{style:{fontWeight:"700",color:ze>.01?"#f59e0b":I?"#22c55e":"#ef4444"},children:_e})]})]}),e.jsxs(mt,{style:{marginBottom:10,padding:15,backgroundColor:me==="#dc3545"?"#fef2f2":me==="#28a745"?"#ecfccb":"#e0f2fe",color:me==="#dc3545"?"#ef4444":me==="#28a745"?"#4d7c0f":"#0369a1",fontWeight:"800",fontSize:"1.1rem",textAlign:"center",borderRadius:12,border:"none",boxShadow:"0 2px 4px rgba(0,0,0,0.05)"},children:[e.jsx(Vt,{style:{marginRight:8}})," ",ne]})]}),e.jsxs("div",{style:{marginTop:"auto",display:"flex",flexDirection:"column",gap:"12px"},children:[e.jsxs(k,{type:"button",onClick:f=>{f.preventDefault(),g(!0)},disabled:se||!I,style:{width:"100%",padding:"16px 0",fontSize:"1.2rem",fontWeight:800,backgroundColor:se||!I?"#cbd5e1":"#2563eb",color:"white",border:"none",borderRadius:10,boxShadow:se||!I?"none":"0 4px 6px -1px rgba(37, 99, 235, 0.4)",transition:"all 0.2s"},children:[e.jsx(Nt,{style:{marginRight:8}})," PAGAR E IMPRIMIR"]}),e.jsxs(k,{type:"button",onClick:f=>{f.preventDefault(),g(!1)},disabled:se||!I,style:{width:"100%",padding:"12px 0",fontSize:"1rem",fontWeight:700,backgroundColor:"white",color:se||!I?"#cbd5e1":"#475569",border:se||!I?"1px solid #e2e8f0":"2px solid #cbd5e1",borderRadius:10,transition:"all 0.2s"},children:[e.jsx(qt,{style:{marginRight:8}})," Solo Guardar (Sin Ticket)"]})]})]})]})]})})},Ao=Gt`
  @media print {
    body { visibility: hidden; margin: 0; padding: 0; }
    .print-area, .print-area * { visibility: visible !important; }
    .print-area {
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      z-index: 999999 !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    .no-print { display: none !important; }
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      box-shadow: none !important;
      text-shadow: none !important;
    }
  }
`,Ro=Fe.div`
  font-family: 'Consolas','Courier New',monospace;
  color: #000;
  background: #fff;
  width: 310px;
  margin: 0 auto;
  padding: 12px 10px;
  box-shadow: 0 0 10px rgba(0,0,0,.08);
  border: 1px solid #eee;
  border-radius: 8px;

  &.compact { padding: 8px 6px; }

  /* Encabezado */
  .brand {
    text-align: center;
    border-bottom: 1px dashed #333;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }
  .brand h1 { margin: 6px 0 2px; font-size: 1.35rem; font-weight: 700; color: #0b72b9; line-height: 1.25; }
  .brand small { color: #555; display: block; margin: 3px 0; line-height: 1.35; white-space: normal; word-break: break-word; }

  /* Meta */
  .meta { font-size: .9rem; margin-bottom: 12px; border-bottom: 1px dashed #ccc; padding-bottom: 8px; }
  .meta p { margin: 2px 0; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 4px 8px; font-weight: 400; }
  .meta-label { font-weight: 700; }
  .meta-value { font-weight: 400; }

  /* Tabla */
  table.items { width: 100%; border-collapse: collapse; font-size: .9rem; table-layout: fixed; }
  table.items th, table.items td { padding: 6px 4px; vertical-align: top; word-wrap: break-word; }
  table.items th { border-bottom: 2px solid #333; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; color: #1e3a8a; }
  &.compact table.items th, &.compact table.items td { padding: 4px 2px; }
  .text-right { text-align: right; }
  .col-qty { width: 15%; text-align: center; }
  .col-unit { width: 25%; text-align: right; }
  .col-total { width: 25%; text-align: right; }
  table.items td:nth-child(2) { white-space: normal; text-align: left; }

  /* Totales */
  .totals { border-top: 2px solid #333; padding-top: 6px; margin-top: 12px; }
  .badge { display: inline-block; font-weight: 700; letter-spacing: .5px; padding: 6px 10px; border: 2px solid #0b72b9; border-radius: 4px; margin: 10px auto; text-align: center; color: #0b72b9; font-size: 0.8rem; }
  .thanks { text-align: center; font-size: .85rem; border-top: 1px dashed #333; padding-top: 10px; margin-top: 12px; color: #444; line-height: 1.4; }

  /* ====== A4 SPECIFIC LAYOUT ====== */
  &.print-a4 {
    .brand { display: flex; justify-content: space-between; align-items: flex-start; text-align: left; border-bottom: 3px solid #1e3a8a; margin-bottom: 2rem; padding-bottom: 1rem; }
    .brand-logo-container { width: 150px; }
    .brand-info { text-align: right; max-width: 60%; }
    .brand h1 { font-size: 20pt; color: #1e3a8a; margin-bottom: 5px; }
    .brand small { font-size: 9pt; color: #444; margin: 1px 0; }
    
    .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border: 1px solid #ddd; padding: 15px; background: #f8fafc; border-radius: 6px; margin-bottom: 25px; }
    .meta-col { display: flex; flex-direction: column; gap: 5px; }
    .meta-title { font-weight: bold; text-transform: uppercase; color: #1e3a8a; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 6px; font-size: 9pt; }
    .meta p { justify-content: flex-start; gap: 8px; border-bottom: none; width: 100%; display: grid; grid-template-columns: 100px 1fr; }
    
    table.items th { background: #f1f5f9; color: #334155; padding: 10px; border-bottom: 2px solid #cbd5e1; font-size: 9pt; }
    table.items td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 10pt; color: #334155; }
    .col-qty { width: 10%; }
    .col-unit { width: 15%; }
    .col-total { width: 15%; }
    
    .totals { border-top: none; margin-top: 0; display: flex; justify-content: flex-end; padding-top: 20px; }
    .totals-box { width: 250px; }
    
    .thanks { border-top: none; margin-top: 50px; font-style: italic; color: #94a3b8; }
  }

  @media print {
    &.print-80 {
      width: 80mm !important; font-family: 'Consolas', monospace !important; padding: 6px 4px !important; border: none !important; box-shadow: none !important; font-size: 8pt;
    }
    &.print-a4 {
      width: 190mm !important; font-size: 10pt !important; padding: 0 !important; margin: 0 !important; border: none !important; box-shadow: none !important; max-height: 277mm !important; overflow: hidden !important; font-family: 'Inter', Helvetica, Arial, sans-serif !important;
    }
    &.compact { font-size: 7.5pt; }
  }
`,Oo=Fe.div`
  display: flex; flex-direction: column; gap: 12px;
`,Mo=Fe.img`
  width: 100%; max-width: 160px; height: auto; display: block; margin: 0 auto 6px; border-radius: 6px;
  &.a4-logo { margin: 0; max-width: 140px; }
`,Po=Fe.span`
  display: inline-flex; align-items: center; gap: 6px; font-weight: 700; letter-spacing: .4px; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; background: #e8f4ff; color: #0b72b9; border: 1px solid #b9defc;
`,$o=Fe.div`
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: .75rem;
`,Bo=({cart:n=[],total:z=0,subtotal:r=0,discount:L=0,proformaFor:B="",onClose:Q,currentUser:p,client:U})=>{const{user:w}=typeof tt=="function"?tt():{user:null},{settings:b}=ho(),_=u=>(u==null?void 0:u.usuarioNombre)||(u==null?void 0:u.nombre_usuario)||(u==null?void 0:u.name)||(u==null?void 0:u.nombre)||(u==null?void 0:u.username)||null;let K=null;try{K=JSON.parse(localStorage.getItem("authUser")||"null")}catch{}const ae=_(p)||_(w)||_(K)||"Cajero POS",j=(U==null?void 0:U.nombre)||"Consumidor Final",l=(U==null?void 0:U.cedula)||"",m=new Date().toLocaleString("es-NI"),y=u=>new Intl.NumberFormat("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(u||0)),x={name:(b==null?void 0:b.empresa_nombre)||"Multirepuestos RG",ruc:(b==null?void 0:b.empresa_ruc)||"1211812770001E",phone:(b==null?void 0:b.empresa_telefono)||"84031936 / 84058142",address:(b==null?void 0:b.empresa_direccion)||"Del portón de la normal 75 varas al este. Juigalpa, Chontales.",slogan:(b==null?void 0:b.empresa_eslogan)||"Repuestos de confianza al mejor precio",logo:b!=null&&b.empresa_logo_url?(b.empresa_logo_url.startsWith("http"),b.empresa_logo_url):new URL("/icons/logo.png",window.location.origin).toString()},V=i.useCallback((u="80")=>{const q=document.getElementById("print-wrapper-proforma");if(!q)return;const te=q.outerHTML,D=`
      @charset "UTF-8";
      @page { size: ${u==="A4"?"A4 portrait":"80mm auto"}; margin: ${u==="A4"?"12mm":"0"}; }
      html, body {
        background: #fff; margin: 0 !important; padding: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color: #000 !important; font-family: ${u==="A4"?"'Inter', Helvetica, Arial, sans-serif":"'Consolas', monospace"};
      }
      
      #print-wrapper-proforma {
        box-shadow: none !important; border: none !important; margin: 0 !important;
        ${u==="A4"?"width: 100% !important; padding: 0 !important; font-size: 10pt !important;":"width: 80mm !important; padding: 6px 4px !important; font-size: 8pt !important;"}
      }

      ${u==="A4"?`
        #print-wrapper-proforma .brand { display: flex !important; justify-content: space-between !important; align-items: flex-start !important; text-align: left !important; border-bottom: 3px solid #1e3a8a !important; margin-bottom: 25px !important; padding-bottom: 15px !important; }
        #print-wrapper-proforma .brand-logo-container { width: 140px !important; order: 1 !important; }
        #print-wrapper-proforma .brand-info { flex: 1 !important; text-align: right !important; order: 2 !important; }
        #print-wrapper-proforma .brand h1 { font-size: 22pt !important; color: #1e3a8a !important; margin: 0 0 5px 0 !important; }
        #print-wrapper-proforma .brand small { display: block !important; font-size: 9pt !important; margin: 2px 0 !important; color: #334155 !important; }
        
        #print-wrapper-proforma .meta { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 30px !important; background: #f8fafc !important; border: 1px solid #e2e8f0 !important; padding: 15px !important; margin-bottom: 30px !important; border-radius: 8px !important; }
        #print-wrapper-proforma .meta p { display: grid !important; grid-template-columns: 100px 1fr !important; width: 100% !important; border-bottom: 1px dashed #e2e8f0 !important; padding-bottom: 4px !important; margin-bottom: 4px !important; }
        #print-wrapper-proforma .meta-title { font-weight: 800 !important; text-transform: uppercase !important; color: #1e3a8a !important; border-bottom: 2px solid #cbd5e1 !important; margin-bottom: 10px !important; padding-bottom: 5px !important; display: block !important; width: 100% !important; }

        #print-wrapper-proforma table.items { width: 100% !important; border-collapse: collapse !important; border: 1px solid #e2e8f0 !important; }
        #print-wrapper-proforma table.items th { background: #f1f5f9 !important; color: #334155 !important; padding: 12px 8px !important; border-bottom: 2px solid #cbd5e1 !important; font-size: 9pt !important; text-align: left !important; }
        #print-wrapper-proforma table.items td { padding: 10px 8px !important; border-bottom: 1px solid #f1f5f9 !important; font-size: 9.5pt !important; vertical-align: top !important; }
        #print-wrapper-proforma .col-qty { text-align: center !important; }
        #print-wrapper-proforma .col-unit, #print-wrapper-proforma .col-total { text-align: right !important; }
        
        #print-wrapper-proforma .totals { display: flex !important; justify-content: flex-end !important; margin-top: 20px !important; border-top: none !important; }
        #print-wrapper-proforma .totals-box { width: 300px !important; background: #f8fafc !important; padding: 15px !important; border: 1px solid #e2e8f0 !important; border-radius: 8px !important; }
      `:`
        #print-wrapper-proforma .brand { text-align: center !important; border-bottom: 1px dashed #333 !important; }
        #print-wrapper-proforma .meta p { display: flex !important; justify-content: space-between !important; }
      `}
    `,c=window.open("","_blank","width=900,height=700");c&&(c.document.write(`<html><head><title>PROFORMA - ${x.name}</title><style>${D}</style></head><body>${te}</body></html>`),c.document.close(),c.focus(),c.onload=function(){setTimeout(()=>{c.print()},250)})},[x]),W=n.length<=2;return e.jsxs(Ee,{className:"no-print",children:[e.jsx(Ao,{}),e.jsxs(Be,{className:"no-print",style:{maxWidth:520,width:"96%",padding:"1.2rem",background:"#fff"},children:[e.jsxs($o,{children:[e.jsxs("h2",{style:{display:"flex",alignItems:"center",gap:8,margin:0},children:[e.jsx(Ht,{})," Vista Proforma"]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(k,{onClick:()=>V("80"),children:"Ticket 80mm"}),e.jsxs(k,{onClick:()=>V("A4"),children:[e.jsx(Qe,{})," A4"]}),e.jsx(k,{$cancel:!0,onClick:Q,children:e.jsx(Ze,{})})]})]}),e.jsx(Oo,{children:e.jsxs(Ro,{id:"print-wrapper-proforma",className:`print-area print-80 ${W?"compact":""}`,children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"brand-logo-container",children:e.jsx(Mo,{className:"a4-logo",src:x.logo,alt:"Logo",onError:u=>{u.currentTarget.style.display="none"}})}),e.jsxs("div",{className:"brand-info",children:[e.jsx("h1",{children:x.name}),e.jsx("small",{children:x.slogan}),e.jsxs("small",{children:["RUC: ",x.ruc]}),e.jsxs("small",{children:["Tel: ",x.phone]}),e.jsx("small",{children:x.address}),e.jsx("div",{style:{marginTop:8},children:e.jsxs(Po,{children:[e.jsx(Qe,{})," PROFORMA"]})})]})]}),e.jsxs("div",{className:"meta",children:[e.jsxs("div",{className:"meta-col",children:[e.jsx("span",{className:"meta-title",children:"Detalles"}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Fecha:"}),e.jsx("span",{className:"meta-value",children:m})]}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"ID Temp:"}),e.jsx("span",{className:"meta-value",children:Date.now().toString().slice(-6)})]}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Atendido por:"}),e.jsx("span",{className:"meta-value",children:ae})]})]}),e.jsxs("div",{className:"meta-col",children:[e.jsx("span",{className:"meta-title",children:"Cliente"}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Nombre:"}),e.jsx("span",{className:"meta-value",children:B||j})]}),l&&e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Cédula:"}),e.jsx("span",{className:"meta-value",children:l})]})]})]}),e.jsxs("table",{className:"items",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-qty",children:"Cant."}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{className:"text-right col-unit",children:"P. Unit."}),e.jsx("th",{className:"text-right col-total",children:"Total"})]})}),e.jsx("tbody",{children:n.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",style:{textAlign:"center",color:"#777"},children:"Sin ítems"})}):n.map((u,q)=>{const te=Number(u.precio_venta??u.precio??0),D=Number(u.quantity??0),c=te*D;return e.jsxs("tr",{children:[e.jsx("td",{className:"col-qty",children:D}),e.jsx("td",{children:u.nombre||u.descripcion||"Item"}),e.jsxs("td",{className:"text-right col-unit",children:["C$",y(te)]}),e.jsxs("td",{className:"text-right col-total",children:["C$",y(c)]})]},q)})})]}),e.jsx("div",{className:"totals",children:e.jsxs("div",{className:"totals-box",children:[e.jsxs(ie,{children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["C$",y(r)]})]}),L>0&&e.jsxs(ie,{style:{color:"#dc3545"},children:[e.jsx("span",{children:"Descuento:"}),e.jsxs("span",{children:["- C$",y(L)]})]}),e.jsxs(ie,{className:"grand-total",style:{fontWeight:"bold",fontSize:"1.2rem",marginTop:5,borderTop:"2px solid black"},children:[e.jsx("span",{children:"TOTAL:"}),e.jsxs("span",{children:["C$",y(z)]})]}),e.jsxs("div",{style:{marginTop:12,textAlign:"center"},children:[e.jsx("span",{className:"badge",children:"DOCUMENTO NO VÁLIDO COMO FACTURA"}),e.jsx("p",{style:{margin:"5px 0 0",fontSize:"0.75rem",color:"#666"},children:"Precios sujetos a cambio. Válido por 3 días."})]})]})}),e.jsxs("div",{className:"thanks",children:[e.jsxs("p",{children:['"',x.slogan,'"']}),e.jsx("p",{style:{whiteSpace:"pre-line",marginTop:"5px"},children:(b==null?void 0:b.ticket_proforma_footer)||"¡Gracias por cotizar con nosotros!"})]})]})})]})]})},De=({isOpen:n,onClose:z,onConfirm:r,onSubmit:L,title:B,message:Q,fields:p=[],inputType:U="number",icon:w})=>{const[b,_]=i.useState({}),[K,ae]=i.useState("");if(i.useEffect(()=>{if(n)if(p.length>0){const m={};p.forEach(y=>{m[y.name]=y.defaultValue!==void 0?y.defaultValue:""}),_(m)}else ae("")},[n,p]),!n)return null;const j=()=>{p.length>0?L?L(b):r&&r(b):L?L(K):r&&r(K)},l=(m,y)=>{_(x=>({...x,[m]:y}))};return e.jsx(Ee,{children:e.jsxs(Be,{style:{maxWidth:"450px"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:"1.5rem"},children:[w?e.jsx("div",{style:{fontSize:"2.5rem",marginBottom:"1rem"},children:w}):e.jsx(Jt,{size:"2.5em",color:"#007bff"}),e.jsx("h2",{style:{marginTop:"0.5rem",marginBottom:"0.5rem"},children:B}),Q&&e.jsx("p",{style:{color:"#6c757d"},children:Q})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:p.length>0?p.map(m=>e.jsxs("div",{children:[m.label&&e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:600,fontSize:"0.9rem"},children:m.label}),m.type==="select"?e.jsx("select",{value:b[m.name],onChange:y=>l(m.name,y.target.value),style:{width:"100%",padding:"10px",borderRadius:"8px",border:"1px solid #ccc",fontSize:"1rem"},children:m.options&&m.options.map(y=>e.jsx("option",{value:y.value,children:y.label},y.value))}):e.jsx(ee,{type:m.type||"text",placeholder:m.placeholder||"",value:b[m.name],onChange:y=>l(m.name,y.target.value),autoFocus:m.name===p[0].name})]},m.name)):e.jsx(ee,{type:U,value:K,onChange:m=>ae(m.target.value),autoFocus:!0})}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"1rem",marginTop:"2rem"},children:[e.jsx(k,{onClick:z,style:{backgroundColor:"#6c757d"},children:"Cancelar"}),e.jsx(k,{onClick:j,primary:!0,children:"Aceptar"})]})]})})},Ge=Fe.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
  
  label { font-weight: bold; color: #495057; }
  input { width: 120px; text-align: right; }
`,_o=({isOpen:n,onClose:z,currentStats:r,onConfirm:L})=>{const[B,Q]=i.useState("manual"),[p,U]=i.useState({efectivo:"",credito:"",tarjeta:"",dolares:""}),[w,b]=i.useState({cordobas:"",dolares:""}),_=(j,l)=>{U(m=>({...m,[j]:l}))},K=(j,l)=>{b(m=>({...m,[j]:l}))},ae=()=>{const j=[];if(B==="manual")parseFloat(p.efectivo)&&j.push({target:"efectivo",amount:parseFloat(p.efectivo)}),parseFloat(p.credito)&&j.push({target:"credito",amount:parseFloat(p.credito)}),parseFloat(p.tarjeta)&&j.push({target:"tarjeta",amount:parseFloat(p.tarjeta)});else{const l=parseFloat(w.cordobas),m=parseFloat(w.dolares);if(!isNaN(l)){const y=Number((r==null?void 0:r.netCordobas)||0),x=l-y;Math.abs(x)>.01&&j.push({target:"efectivo",amount:x})}if(!isNaN(m)){const y=Number((r==null?void 0:r.netDolares)||0),x=m-y;Math.abs(x)>.01&&j.push({target:"dolares",amount:x})}}j.length>0&&L(j),z()};return n?e.jsx(Ee,{style:{background:"rgba(0,0,0,0.95)",zIndex:9999},children:e.jsxs(Be,{style:{maxWidth:"450px",background:"#212529",color:"#fff",border:"1px solid #495057"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsxs("h2",{style:{margin:0,color:"#ffc107",display:"flex",alignItems:"center",gap:10},children:[e.jsx(Qt,{})," GOD MODE"]}),e.jsx(k,{$cancel:!0,onClick:z,style:{background:"transparent",color:"#6c757d",border:"none"},children:"✕"})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginBottom:20},children:[e.jsx(k,{onClick:()=>Q("manual"),style:{flex:1,background:B==="manual"?"#ffc107":"#343a40",color:B==="manual"?"#000":"#fff",border:"none"},children:"Ajuste Manual (+/-)"}),e.jsx(k,{onClick:()=>Q("override"),style:{flex:1,background:B==="override"?"#ffc107":"#343a40",color:B==="override"?"#000":"#fff",border:"none"},children:"Fijar Monto (=)"})]}),B==="manual"?e.jsxs(e.Fragment,{children:[e.jsx("p",{style:{color:"#adb5bd",fontSize:"0.85rem",marginBottom:15},children:"Suma o resta cantidades a los contadores ocultamente."}),e.jsxs(Ge,{style:{background:"#343a40"},children:[e.jsx("label",{style:{color:"#fff"},children:"Efectivo (C$)"}),e.jsx(ee,{type:"number",step:"0.01",placeholder:"+/- 0.00",value:p.efectivo,onChange:j=>_("efectivo",j.target.value),style:{background:"#495057",color:"#fff"}})]}),e.jsxs(Ge,{style:{background:"#343a40"},children:[e.jsx("label",{style:{color:"#fff"},children:"Crédito"}),e.jsx(ee,{type:"number",step:"0.01",placeholder:"+/- 0.00",value:p.credito,onChange:j=>_("credito",j.target.value),style:{background:"#495057",color:"#fff"}})]}),e.jsxs(Ge,{style:{background:"#343a40"},children:[e.jsx("label",{style:{color:"#fff"},children:"Tarjeta"}),e.jsx(ee,{type:"number",step:"0.01",placeholder:"+/- 0.00",value:p.tarjeta,onChange:j=>_("tarjeta",j.target.value),style:{background:"#495057",color:"#fff"}})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{style:{color:"#adb5bd",fontSize:"0.85rem",marginBottom:15},children:"Define EXACTAMENTE cuánto dinero físico hay. El sistema creará un ajuste mágico para cuadrar."}),e.jsxs("div",{style:{background:"#343a40",padding:10,borderRadius:6,marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.85rem",color:"#aaa",marginBottom:5},children:[e.jsx("span",{children:"Sistema Actual:"}),e.jsxs("span",{children:["C$ ",Number((r==null?void 0:r.netCordobas)||0).toFixed(2)]})]}),e.jsxs(Ge,{style:{background:"transparent",padding:0,marginBottom:0},children:[e.jsx("label",{style:{color:"#fff"},children:"Real en Caja (C$)"}),e.jsx(ee,{type:"number",step:"0.01",placeholder:"0.00",value:w.cordobas,onChange:j=>K("cordobas",j.target.value),style:{background:"#495057",color:"#fff",border:"1px solid #ffc107"}})]})]}),e.jsxs("div",{style:{background:"#343a40",padding:10,borderRadius:6},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.85rem",color:"#aaa",marginBottom:5},children:[e.jsx("span",{children:"Sistema Actual:"}),e.jsxs("span",{children:["$ ",Number((r==null?void 0:r.netDolares)||0).toFixed(2)]})]}),e.jsxs(Ge,{style:{background:"transparent",padding:0,marginBottom:0},children:[e.jsx("label",{style:{color:"#fff"},children:"Real en Caja ($)"}),e.jsx(ee,{type:"number",step:"0.01",placeholder:"0.00",value:w.dolares,onChange:j=>K("dolares",j.target.value),style:{background:"#495057",color:"#fff",border:"1px solid #ffc107"}})]})]})]}),e.jsxs("div",{style:{marginTop:25,display:"flex",gap:10},children:[e.jsx(k,{onClick:z,style:{flex:1,background:"#495057",border:"none"},children:"Cancelar"}),e.jsxs(k,{onClick:ae,style:{flex:1,background:"#ffc107",color:"#000",fontWeight:"bold",border:"none"},children:[e.jsx(Ut,{style:{marginRight:6}})," ",B==="manual"?"APLICAR AJUSTE":"CUADRAR MÁGICAMENTE"]})]})]})}):null},Ie=n=>Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),Uo=()=>{var Pe,$e,We,qe,ot,at,nt;const{user:n,products:z,token:r,refreshProducts:L,clients:B,allUsers:Q}=tt(),{isCajaOpen:p,setIsCajaOpen:U,cajaSession:w,setCajaSession:b,tasaDolar:_,setTasaDolar:K,closeCajaSession:ae,refreshSession:j}=bo(),{orders:l,activeOrderId:m,setActiveOrderId:y,activeOrder:x,handleNewOrder:V,handleRemoveOrder:W,updateActiveOrder:u,loadOrdersFromDB:q,checkForNewOrders:te}=jo(),D=(n==null?void 0:n.id_usuario)||(n==null?void 0:n.id),c=n,Ne=(n==null?void 0:n.rol)==="admin",[je,ye]=i.useState(z||[]),[ke,Ae]=i.useState(""),[Ue,Te]=i.useState("description"),[fe,I]=i.useState(!1),[E,X]=i.useState({name:null,data:null}),[we,oe]=i.useState(null),[de,Z]=i.useState({isOpen:!1,title:"",message:""}),[H,re]=i.useState({isOpen:!1,title:"",message:"",onConfirm:null}),[ze,ce]=i.useState(!1),G=i.useRef(null),pe=i.useMemo(()=>{if(!(w!=null&&w.transactions))return{netCordobas:0,netDolares:0};let t=0,o=0;const a=w.transactions,d=Number(w.initialAmount||0);t+=d;for(const h of a){const C=(h.type||"").toLowerCase();let N=h.pagoDetalles||{};if(typeof N=="string")try{N=JSON.parse(N)}catch{N={}}let v=Number(N.ingresoCaja!==void 0?N.ingresoCaja:h.amount||0);(C==="salida"||C.includes("devolucion"))&&(v=-Math.abs(v)),C.startsWith("venta")?N.efectivo!==void 0||N.dolares!==void 0?(t+=Number(N.efectivo||0)-Number(N.cambio||0),o+=Number(N.dolares||0)):t+=v-Number(N.tarjeta||0)-Number(N.transferencia||0)-Number(N.credito||0):C.includes("abono")?N.dolares!==void 0?(o+=Number(N.dolares||0),t+=Number(N.efectivo||0)):t+=v:C==="entrada"?t+=Math.abs(v):C==="salida"?t-=Math.abs(v):C==="ajuste"?(N.target==="efectivo"&&(t+=Number(h.amount||0)),N.target==="dolares"&&(o+=Number(h.amount||0))):t+=v}return{netCordobas:t,netDolares:o}},[w]),_e=i.useCallback(()=>{try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;const o=new t,a=o.createOscillator(),d=o.createGain();a.connect(d),d.connect(o.destination),a.type="sine",a.frequency.setValueAtTime(1200,o.currentTime),d.gain.setValueAtTime(.1,o.currentTime),a.start(),a.stop(o.currentTime+.1)}catch{}},[]),O=(x==null?void 0:x.items)||[],se=O.reduce((t,o)=>t+o.precio_venta*o.quantity,0),S=((Pe=x==null?void 0:x.discount)==null?void 0:Pe.type)==="percentage"?se*x.discount.value/100:(($e=x==null?void 0:x.discount)==null?void 0:$e.value)||0,ue=se-S;i.useEffect(()=>{z&&ye(z)},[z]),i.useEffect(()=>{if(D){q(D);const t=setInterval(()=>{document.hidden||te(D)},5e3);return()=>clearInterval(t)}},[D,q,te]);const T=({title:t,message:o})=>Z({isOpen:!0,title:t,message:o}),Re=()=>Z({isOpen:!1}),s=({title:t,message:o,onConfirm:a})=>{re({isOpen:!0,title:t,message:o,onConfirm:a})},F=()=>re({isOpen:!1,title:"",message:"",onConfirm:null}),$=(t,o=null)=>X({name:t,data:o}),g=()=>X({name:null,data:null}),me=async()=>{try{await L(),D&&await q(D)}catch(t){console.error("Error refreshing data",t)}},ne=t=>u("items",t),f=()=>{$("pinPrompt",{action:()=>ce(!0)})},Y=async t=>{for(const o of t){const a={type:"ajuste",amount:o.amount,at:new Date().toISOString(),userId:D,note:`Ajuste Interno (${o.target})`,pagoDetalles:{target:o.target,hidden:!0,amount:o.amount,efectivo:o.target==="efectivo"?o.amount:0,dolares:o.target==="dolares"?o.amount:0,credito:o.target==="credito"?o.amount:0,tarjeta:o.target==="tarjeta"?o.amount:0},id:"ADJ-"+Date.now()+"-"+Math.random().toString(36).substr(2,5)};try{await Xe({userId:D,tx:a},r)}catch(d){console.error("Error saving secret adjust:",d)}}await j(),T({title:"Procesado",message:"Ajustes aplicados correctamente."})},ge=(t,o=1)=>{window.innerWidth<=960&&I(!0);const a=t.id_producto||t.id,d=O.find(R=>(R.id_producto||R.id)===a),h=((d==null?void 0:d.quantity)||0)+o,C=t.disponible!==void 0?t.disponible:t.existencia;if(C<=0){T({title:"Sin Stock",message:`El producto "${t.nombre}" no tiene existencia disponible.`});return}if(h>C){T({title:"Stock Insuficiente",message:`Solo hay ${C} unidades disponibles.`});return}_e();const N=(d==null?void 0:d.precio_venta)||t.venta||t.precio||0,v={...t,id:a,id_producto:a,quantity:h,precio_venta:N},P=d?O.map(R=>(R.id_producto||R.id)===a?v:R):[...O,v];ne(P)},J=(t,o)=>{var N;const a=t,d=je.find(v=>(v.id_producto||v.id)===a)||O.find(v=>(v.id_producto||v.id)===a);if(!d)return;let h=parseInt(o,10)||0;if(h<=0){ne(O.filter(v=>(v.id_producto||v.id)!==a));return}const C=d.disponible!==void 0?d.disponible:d.existencia;h>(C||9999)&&(h=C,T({title:"Stock",message:"Cantidad máxima alcanzada según inventario."})),h>(((N=O.find(v=>(v.id_producto||v.id)===a))==null?void 0:N.quantity)||0)&&_e(),ne(O.map(v=>(v.id_producto||v.id)===a?{...v,quantity:h}:v))},Oe=async t=>{var v;const o=m,a=l.find(P=>P.id===o);if(O.length===0)return T({title:"Carrito Vacío",message:"No hay productos para facturar."}),!1;const d=O.map(P=>({id_producto:P.id_producto||P.id,quantity:P.quantity,precio:P.precio_venta,nombre:P.nombre,codigo:P.codigo,costo:P.costo||0})),h={totalVenta:ue,subtotal:se,descuento:S,items:d,pagoDetalles:t,userId:D,clientId:Number(t.clienteId||0),tasaDolarAlMomento:_,originalOrderId:(a==null?void 0:a.serverSaleId)||null},C=!t.shouldPrintNow,N=async()=>{var P;try{const R=await So(h,r);L().catch(console.error);const xe=R.data||R||{},be={...h,...xe};if(be.id=xe.id||xe.saleId||xe._id||"N/A",be.items=d,be.pagoDetalles=t,be.fecha=new Date().toISOString(),t.shouldPrintNow&&oe(be),W(o),p&&w){const Se={...t};!Se.tarjeta&&!Se.transferencia&&!Se.credito&&Se.efectivo===void 0&&(Se.efectivo=h.totalVenta);const kt=((P=B.find(Ye=>Ye.id_cliente===Number(t.clienteId)))==null?void 0:P.nombre)||"Consumidor Final",Tt=Number(h.totalVenta||0);Se.efectivo=Number(Se.efectivo||0);const it={type:"venta",amount:Tt,at:new Date().toISOString(),userId:D,note:`Venta #${be.id} - ${kt}`,pagoDetalles:Se,id:be.id};if(Xe({userId:D,tx:it},r).catch(console.error),!C){const Ye={...w,transactions:[it,...w.transactions||[]]};b(Ye)}}}catch(R){console.error("CRITICAL: Error saving sale in background:",R),T({title:"⚠️ Error de Sincronización",message:`La venta por C$ ${Ie(ue)} NO se guardó en el servidor.
Error: ${R.message}.

Por favor, anote los detalles o reintente.`})}};if(C){if(W(o),ye(P=>P.map(R=>{const xe=d.find(be=>be.id_producto===(R.id_producto||R.id));return xe?{...R,existencia:Math.max(0,R.existencia-xe.quantity)}:R})),p&&w){const P={...t},R=((v=B.find(rt=>rt.id_cliente===Number(t.clienteId)))==null?void 0:v.nombre)||"Consumidor Final",be={type:"venta",amount:Number(h.totalVenta||0),at:new Date().toISOString(),userId:D,note:`Venta (Pendiente) - ${R}`,pagoDetalles:P,id:"PEND-"+Date.now()},Se={...w,transactions:[be,...w.transactions||[]]};b(Se)}return T({title:"¡Éxito!",message:"Venta procesada."}),N(),!0}else return await N(),!0},Me=async(t,o,a)=>{if(!o||o<=0){T({title:"Error",message:"Ingrese un monto válido"});return}const d={type:t,amount:parseFloat(o),note:a,at:new Date().toISOString(),userId:D};try{await Xe({userId:D,tx:d},r)}catch(h){console.error("Error saving manual tx:",h),T({title:"Error Servidor",message:"No se guardó en el servidor, pero se actualizará localmente."})}await j(),g(),T({title:"Éxito",message:t==="entrada"?"Entrada registrada":"Salida registrada"})},le=t=>{t&&t.trim()&&(u("name",t.trim()),g(),T({title:"Ticket Renombrado",message:`Nombre actualizado a: ${t.trim()} `}))},A=t=>{var N,v;const o=(N=E.data)==null?void 0:N.item;if(!o)return;const a=parseFloat(t),d=o.costo||((v=o.raw)==null?void 0:v.costo)||0;if(a<d){T({title:"Precio Inválido",message:`El precio C$${a.toFixed(2)} es menor al costo(C$${d.toFixed(2)}).`});return}const h=o.id_producto||o.id,C=O.map(P=>(P.id_producto||P.id)===h?{...P,precio_venta:a}:P);ne(C),g()},M=t=>{const o=t.id_producto||t.id,a=je.find(R=>(R.id_producto||R.id)===o)||t,d=Number(a.mayorista||a.mayoreo||0);if(!d){T({title:"Aviso",message:"Este producto no tiene precio mayorista."});return}const h=Number(t.precio_venta||0),C=Math.abs(h-d)<.01,N=Number(a.venta||a.precio||(C?t.originalPrice:t.precio_venta)||0),v=C?N:d,P=O.map(R=>(R.id_producto||R.id)===o?{...R,precio_venta:v}:R);ne(P),T(C?{title:"Precio Revertido",message:"Se ha restablecido el precio regular."}:{title:"Precio Mayorista",message:"✅ ACTIVADO Precio Mayorista"})},Ve=(t,o)=>{var P,R;const a=(P=E.data)==null?void 0:P.item;if(!a)return;const d=a.id_producto||a.id;let h=a.precio_venta;const C=parseFloat(t);if(isNaN(C)||C<0){T({title:"Valor Inválido",message:"Ingrese un valor de descuento válido."});return}o==="percentage"?h=h-h*(C/100):h=h-C;const N=a.costo||((R=a.raw)==null?void 0:R.costo)||0;if(h<N){T({title:"Precio Inválido",message:`El descuento deja el precio(C$${h.toFixed(2)}) por debajo del costo.`});return}const v=O.map(xe=>(xe.id_producto||xe.id)===d?{...xe,precio_venta:h}:xe);ne(v),g()},Ce=i.useMemo(()=>{const t=new Map;return l.forEach(o=>{o.id!==(x==null?void 0:x.id)&&o.items.forEach(a=>{const d=a.id_producto||a.id,h=Number(a.cantidad||a.quantity||0);t.set(d,(t.get(d)||0)+h)})}),t},[l,x]),he=()=>{let t=0;const o=O.map(a=>{const d=je.find(R=>(R.id_producto||R.id)===(a.id_producto||a.id));if(!d)return a;const h=Number(d.mayorista||d.mayoreo||0);if(!h)return a;const C=Number(a.precio_venta||0),N=Math.abs(C-h)<.01,v=Number(d.venta||d.precio||a.originalPrice||a.precio_venta||0),P=N?v:h;return Math.abs(C-P)>.01?(t++,{...a,precio_venta:P}):a});if(t>0){ne(o);const a=o.find((C,N)=>{var v;return Math.abs(C.precio_venta-(((v=O[N])==null?void 0:v.precio_venta)||0))>.01}),d=je.find(C=>(C.id_producto||C.id)===((a==null?void 0:a.id_producto)||(a==null?void 0:a.id))),h=d&&Math.abs(a.precio_venta-Number(d.mayorista||0))<.01;T({title:"Precio Actualizado",message:`${h?"ACTIVADO":"DESACTIVADO"} precio mayorista en ${t} producto(s).`})}else T({title:"Sin Cambios",message:"No hay productos con precio mayorista disponible o ya están aplicados."})},ve=t=>{u("discount",t),g()};return p?e.jsxs(xt,{children:[e.jsxs(co,{children:[e.jsxs(po,{to:"/dashboard",children:[e.jsx(Kt,{})," Regresar"]}),e.jsx("div",{style:{fontWeight:"800",letterSpacing:"1px",userSelect:"none"},onDoubleClick:f,children:"SISTEMA POS"}),e.jsxs("div",{className:"right-actions",children:[e.jsx(k,{secondary:!0,onClick:me,title:"Sincronizar",children:e.jsx(Xt,{})}),e.jsx(k,{secondary:!0,onClick:()=>$("salesHistory"),title:"Historial de Ventas",children:e.jsx(Zt,{})}),e.jsx(k,{secondary:!0,onClick:()=>$("cashEntry"),title:"Entrada de Dinero",children:e.jsx(eo,{color:"#10b981"})}),e.jsx(k,{secondary:!0,onClick:()=>$("cashExit"),title:"Salida de Dinero",children:e.jsx(to,{color:"#ef4444"})}),e.jsxs(k,{secondary:!0,onClick:()=>$("caja"),children:[e.jsx(Ke,{})," ",(c==null?void 0:c.nombre_usuario)||"Caja"]})]})]}),e.jsxs(mo,{children:[e.jsx(wt,{children:e.jsx(zo,{products:je,searchTerm:ke,setSearchTerm:Ae,searchType:Ue,setSearchType:Te,onProductClick:t=>ge(t,1),cartItems:O,inputRef:G,reservedStock:Ce})}),e.jsx(xo,{isOpen:fe,children:e.jsxs("div",{style:{padding:"1.2rem",display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"1rem"},children:[e.jsxs("h3",{style:{margin:0,display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(oo,{color:"#2563eb"})," Carrito"]}),window.innerWidth<=960&&e.jsx(k,{onClick:()=>I(!1),children:e.jsx(Ct,{})})]}),e.jsxs(fo,{children:[l.map(t=>e.jsxs(k,{primary:t.id===m,secondary:t.id!==m,onClick:()=>y(t.id),onDoubleClick:()=>$("renameTicket"),style:{fontSize:"0.75rem",padding:"6px 10px",display:"flex",alignItems:"center",gap:"5px"},children:[t.name,e.jsx("span",{style:{marginLeft:5,fontWeight:"bold",cursor:"pointer"},onClick:o=>{o.stopPropagation(),W(t.id)},children:"×"})]},t.id)),e.jsx(k,{secondary:!0,onClick:V,title:"Nuevo Ticket",children:e.jsx(dt,{})})]}),e.jsxs("div",{style:{display:"flex",gap:"6px",marginTop:"0.75rem",flexWrap:"wrap"},children:[e.jsxs(k,{secondary:!0,onClick:he,title:"Cambiar a Precio Mayorista",disabled:O.length===0,style:{flex:1,fontSize:"0.75rem",padding:"8px",display:"flex",alignItems:"center",gap:"4px",justifyContent:"center"},children:[e.jsx(ct,{size:12})," Mayorista"]}),e.jsxs(k,{secondary:!0,onClick:()=>$("discount"),title:"Aplicar Descuento",disabled:O.length===0,style:{flex:1,fontSize:"0.75rem",padding:"8px",display:"flex",alignItems:"center",gap:"4px",justifyContent:"center"},children:[e.jsx(Je,{size:12})," Descuento"]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",margin:"1rem 0",paddingRight:"5px"},children:O.length===0?e.jsx("div",{style:{textAlign:"center",color:"#94a3b8",marginTop:"2rem"},children:"Selecciona productos para vender"}):O.map(t=>e.jsxs(uo,{children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:"0.85rem",color:"#1e293b"},children:t.nombre}),e.jsx("div",{style:{fontSize:"0.85rem",fontWeight:"bold",color:"#334155",fontStyle:"normal"},children:t.codigo}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:["Unit: C$ ",Ie(t.precio_venta)]}),e.jsxs("div",{style:{fontSize:"0.85rem",fontWeight:"700",color:"#2563eb",marginTop:"2px"},children:["Total: C$ ",Ie(Number(t.quantity||1)*Number(t.precio_venta||0))]}),e.jsxs("div",{style:{display:"flex",gap:"8px",marginTop:"6px"},children:[e.jsx(Le,{title:"Editar Precio",onClick:()=>$("editPrice",{item:t}),style:{width:26,height:26,background:"#f1f5f9",color:"#334155"},children:e.jsx(pt,{size:10})}),e.jsx(Le,{title:"Precio Mayorista",onClick:()=>M(t),style:{width:26,height:26,background:"#f1f5f9",color:"#334155"},children:e.jsx(ct,{size:10})}),e.jsx(Le,{title:"Descuento Item",onClick:()=>$("itemDiscount",{item:t}),style:{width:26,height:26,background:"#f1f5f9",color:"#334155"},children:e.jsx(Je,{size:10})})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsxs(go,{children:[e.jsx(Le,{onClick:()=>J(t.id_producto||t.id,t.quantity-1),children:e.jsx(ao,{size:8})}),e.jsx("span",{style:{fontWeight:700,minWidth:24,textAlign:"center",fontSize:"0.9rem"},children:t.quantity}),e.jsx(Le,{onClick:()=>J(t.id_producto||t.id,t.quantity+1),children:e.jsx(dt,{size:8})})]}),e.jsx(Le,{onClick:()=>ne(O.filter(o=>(o.id_producto||o.id)!==(t.id_producto||t.id))),style:{color:"#ef4444"},children:e.jsx(no,{size:12})})]})]},t.id_producto||t.id))}),e.jsxs("div",{style:{borderTop:"2px solid #f1f5f9",paddingTop:"1rem"},children:[e.jsxs(ie,{children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["C$ ",Ie(se)]})]}),e.jsxs(ie,{style:{color:"#ef4444"},children:[e.jsx("span",{children:"Descuento"}),e.jsxs("span",{children:["- C$ ",Ie(S)]})]}),e.jsxs(ie,{className:"grand-total",style:{fontSize:"1.4rem",marginTop:"5px"},children:[e.jsx("span",{children:"TOTAL"}),e.jsxs("span",{children:["C$ ",Ie(ue)]})]}),e.jsxs(k,{secondary:!0,style:{width:"100%",marginTop:"1rem",padding:"10px",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"6px",justifyContent:"center"},onClick:()=>$("proformaName"),children:[e.jsx(Qe,{})," Crear Proforma"]}),e.jsx(k,{primary:!0,style:{width:"100%",marginTop:"12px",padding:"16px",fontSize:"1.2rem",fontWeight:"bold"},onClick:()=>$("payment",{total:ue}),disabled:O.length===0,children:"$ COBRAR (F2)"})]})]})}),e.jsxs(ft,{onClick:()=>I(!0),children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{background:"#3b82f6",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.8rem"},children:O.reduce((t,o)=>t+(o.quantity||0),0)}),e.jsx("span",{children:"Ver Venta"})]}),e.jsxs("span",{children:["C$ ",Ie(ue)]})]})]}),e.jsxs(yt,{children:[de.isOpen&&e.jsx(Ee,{onClick:Re,children:e.jsxs(Be,{onClick:t=>t.stopPropagation(),style:{maxWidth:"380px",textAlign:"center"},children:[e.jsx("h2",{style:{marginTop:0},children:de.title}),e.jsx("p",{style:{color:"#475569"},children:de.message}),e.jsx(k,{primary:!0,onClick:Re,style:{width:"100%",marginTop:"1rem"},children:"Entendido"})]})}),H.isOpen&&e.jsx(Ee,{onClick:F,children:e.jsxs(Be,{onClick:t=>t.stopPropagation(),style:{maxWidth:"380px",textAlign:"center"},children:[e.jsx("h2",{style:{marginTop:0},children:H.title}),e.jsx("p",{style:{color:"#475569"},children:H.message}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginTop:"1rem"},children:[e.jsx(k,{onClick:F,style:{flex:1},children:"Cancelar"}),e.jsx(k,{primary:!0,onClick:()=>{var t;(t=H.onConfirm)==null||t.call(H),F()},style:{flex:1},children:"Confirmar"})]})]})}),E.name==="payment"&&e.jsx(Fo,{isOpen:!0,onClose:g,total:E.data.total,onFinishSale:Oe,tasaDolar:_,clientes:B||[],showAlert:T}),E.name==="caja"&&e.jsx(jt,{isOpen:!0,onClose:g,currentUser:c,isCajaOpen:p,session:w,isAdmin:Ne,clients:B||[],showAlert:T,showConfirmation:s,initialTasaDolar:_,onOpenCaja:async(t,o)=>{try{const a=await gt({userId:D,openedAt:new Date().toISOString(),openedBy:{id:D,name:c==null?void 0:c.nombre_usuario},initialAmount:t,tasaDolar:o},r);await j(),g()}catch{T({title:"Error",message:"No se pudo abrir la caja en el servidor."})}},onCloseCaja:async t=>{try{await ut({userId:D,closedAt:new Date().toISOString(),closedBy:{id:D,name:c==null?void 0:c.nombre_usuario},countedAmount:t,notes:"Cierre desde POS"},r),await j(),g(),T({title:"Caja Cerrada",message:"La sesión se ha cerrado y guardado correctamente."})}catch(o){console.error(o),T({title:"Error",message:"Error cerrando caja en servidor."})}}}),E.name==="salesHistory"&&e.jsx(No,{isOpen:!0,onClose:g,dailySales:[],loadSales:async t=>{try{return await vo(r,t)||[]}catch(o){return console.error("Error loading sales:",o),[]}},isAdmin:Ne,users:Q,clients:B||[],onReprintTicket:t=>{oe(t)},onCancelSale:async t=>{try{const o=(t==null?void 0:t.id)||t;if(await Co(o,r),T({title:"Venta Cancelada",message:`La venta #${o} ha sido cancelada exitosamente.`}),p&&w&&typeof t=="object"){let a=typeof t.pagoDetalles=="string"?JSON.parse(t.pagoDetalles||"{}"):t.pagoDetalles||{},d=Number(a.ingresoCaja||0);!d&&a.efectivo&&(d=Number(a.efectivo));const h=a.credito>0;if(d===0&&!h&&t.totalVenta&&(d=Number(t.totalVenta)),d>0){const C={type:"cancelacion",amount:-d,at:new Date().toISOString(),userId:D,userName:(c==null?void 0:c.nombre_usuario)||"Caja",note:`Cancelación Venta #${o}`,pagoDetalles:{efectivo:d,ingresoCaja:-d},id:"CANCEL-"+Date.now()},N={...w,transactions:[C,...w.transactions||[]]};b(N),console.log("Caja actualizada por cancelación:",C)}}}catch(o){throw console.error("Cancel error:",o),T({title:"Error",message:"No se pudo cancelar la venta: "+(o.message||"Error desconocido")}),o}},onReturnItem:async(t,o,a)=>{try{const d={originalSaleId:t.id,item:o,quantity:a,userId:D};await yo(d,r);const C=(o.precio||o.precio_venta||0)*a;if(p&&w){const N={type:"devolucion",amount:-C,at:new Date().toISOString(),userId:D,userName:(c==null?void 0:c.nombre_usuario)||"Caja",note:`Devolución: ${a}x ${o.nombre}`,pagoDetalles:{efectivo:C,ingresoCaja:-C},id:"REFUND-"+Date.now()},v={...w,transactions:[N,...w.transactions||[]]};b(v),T({title:"Devolución Exitosa",message:`Devolución registrada en sistema y C$${C.toFixed(2)} descontados de caja.`})}else T({title:"Devolución Exitosa (Caja Cerrada)",message:"Devolución registrada, pero NO se descontó de caja porque está cerrada."})}catch(d){throw console.error("Return error:",d),T({title:"Error",message:"Error al procesar devolución: "+(d.message||"Error desconocido")}),d}},onAbonoSuccess:()=>{console.log("Abono success")}}),we&&e.jsx(wo,{isOpen:!0,transaction:we,onClose:()=>oe(null),clients:B,users:[n],currentUser:n}),E.name==="proformaName"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Datos de Proforma",fields:[{name:"name",label:"A nombre de:",type:"text",placeholder:"Nombre del Cliente (Opcional)"}],onSubmit:t=>{g(),setTimeout(()=>$("proforma",{proformaFor:t.name}),200)},icon:e.jsx(Qe,{color:"#0b72b9"})}),E.name==="proforma"&&e.jsx(Bo,{isOpen:!0,onClose:g,cart:O,total:ue,subtotal:se,discount:S,proformaFor:(We=E.data)==null?void 0:We.proformaFor,currentUser:c}),E.name==="cashEntry"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Entrada de Dinero",fields:[{name:"amount",label:"Monto (C$)",type:"number",placeholder:"0.00"},{name:"note",label:"Motivo",type:"text",placeholder:"Descripción de la entrada"}],onSubmit:t=>Me("entrada",t.amount,t.note),icon:e.jsx(et,{color:"#10b981"})}),E.name==="cashExit"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Salida de Dinero",fields:[{name:"amount",label:"Monto (C$)",type:"number",placeholder:"0.00"},{name:"note",label:"Motivo",type:"text",placeholder:"Descripción de la salida"}],onSubmit:t=>Me("salida",t.amount,t.note),icon:e.jsx(et,{color:"#ef4444"})}),E.name==="renameTicket"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Renombrar Ticket",fields:[{name:"name",label:"Nuevo Nombre",type:"text",defaultValue:(x==null?void 0:x.name)||"Ticket"}],onSubmit:t=>le(t.name),icon:e.jsx(ro,{color:"#2563eb"})}),E.name==="editPrice"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Editar Precio",fields:[{name:"price",label:`Nuevo Precio(C$)[Costo: C$${(((ot=(qe=E.data)==null?void 0:qe.item)==null?void 0:ot.costo)||0).toFixed(2)}]`,type:"number",defaultValue:(nt=(at=E.data)==null?void 0:at.item)==null?void 0:nt.precio_venta}],onSubmit:t=>A(t.price),icon:e.jsx(pt,{color:"#f59e0b"})}),E.name==="itemDiscount"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Descuento al Producto",fields:[{name:"type",label:"Tipo",type:"select",options:[{value:"fixed",label:"Monto Fijo (C$)"},{value:"percentage",label:"Porcentaje (%)"}],defaultValue:"fixed"},{name:"value",label:"Valor",type:"number",placeholder:"0.00"}],onSubmit:t=>Ve(t.value,t.type),icon:e.jsx(Je,{color:"#2563eb"})}),E.name==="discount"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Aplicar Descuento",fields:[{name:"type",label:"Tipo",type:"select",options:[{value:"fixed",label:"Monto Fijo (C$)"},{value:"percentage",label:"Porcentaje (%)"}],defaultValue:"fixed"},{name:"value",label:"Valor",type:"number",placeholder:"0.00"}],onSubmit:t=>{const o={type:t.type,value:parseFloat(t.value)||0};ve(o)},icon:e.jsx(Je,{color:"#2563eb"})}),e.jsx(ko,{isOpen:H.isOpen,onClose:F,title:H.title,message:H.message,onConfirm:()=>{H.onConfirm&&H.onConfirm(),F()}}),E.name==="pinPrompt"&&e.jsx(De,{isOpen:!0,onClose:g,title:"Acceso Restringido",fields:[{name:"pin",label:"PIN de Seguridad",type:"password",autoFocus:!0}],onSubmit:t=>{var o,a;t.pin==="111987"?(g(),(a=(o=E.data)==null?void 0:o.action)==null||a.call(o)):T({title:"Error",message:"PIN Incorrecto"})},icon:e.jsx(Ke,{color:"#dc3545"})}),ze&&e.jsx(_o,{isOpen:!0,onClose:()=>ce(!1),session:w,currentStats:pe,onConfirm:Y})]}),e.jsxs(ft,{onClick:()=>I(!0),children:[e.jsxs("span",{children:["🛒 Carrito (",O.length,")"]}),e.jsxs("span",{style:{fontWeight:"bold"},children:["C$ ",Ie(ue)]})]})]}):e.jsxs(xt,{style:{alignItems:"center",justifyContent:"center",textAlign:"center"},children:[e.jsx(Ke,{size:50,color:"#cbd5e1",style:{marginBottom:"1rem"}}),e.jsx("h1",{style:{color:"#64748b",margin:"0 0 0.5rem 0"},children:"Caja Cerrada"}),e.jsx("p",{style:{color:"#94a3b8",marginBottom:"1.5rem"},children:"Debes realizar la apertura de caja para procesar ventas."}),e.jsxs(k,{primary:!0,onClick:()=>$("caja"),children:[e.jsx(Yt,{})," Abrir Caja (F9)"]}),E.name==="caja"&&e.jsx(jt,{isOpen:!0,onClose:g,currentUser:c,isCajaOpen:p,session:w,isAdmin:Ne,showAlert:T,showConfirmation:s,initialTasaDolar:_,onOpenCaja:async(t,o)=>{try{const a=await gt({userId:D,openedAt:new Date().toISOString(),openedBy:{id:D,name:(c==null?void 0:c.nombre)||(c==null?void 0:c.nombre_usuario)},initialAmount:t,tasaDolar:o},r);await j(),g()}catch{T({title:"Error",message:"No se pudo abrir la caja en el servidor."})}},onCloseCaja:async t=>{try{const o=await ut({userId:D,closedAt:new Date().toISOString(),closedBy:{id:D,name:(c==null?void 0:c.nombre)||(c==null?void 0:c.nombre_usuario)},countedAmount:t,notes:"Cierre desde POS"},r);await j(),g(),T({title:"Caja Cerrada",message:"La sesión se ha cerrado y guardado correctamente."})}catch(o){console.error(o),T({title:"Error",message:"Error cerrando caja en servidor: "+(o.message||"Desconocido")})}}})]})};export{Uo as default};
